import{c as Q}from"./createLucideIcon-GQ3IAryt.js";import{V as $,_ as Y,u as I,r as S,w as q,b as P,k as ee,d as T,e as t,t as p,F as M,m as R,n as B,v as ne,U as ae,y as k,R as ie}from"./index-I05jmhuU.js";/**
 * @license lucide-vue-next v0.513.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Je=Q("search",[["path",{d:"m21 21-4.34-4.34",key:"14j7rj"}],["circle",{cx:"11",cy:"11",r:"8",key:"4ej97u"}]]),E="/client/media-danh-gia",We={async uploadMedia(h,y){var V;if(!h||!y)throw console.error("Thiếu file hoặc idDanhGia:",{file:h,idDanhGia:y}),new Error("File và idDanhGia là bắt buộc");const c=new FormData;c.append("file",h),c.append("idDanhGia",y),console.log("🚀 Gửi FormData:",{file:h.name,idDanhGia:y});try{return(await $.post(`${E}/upload`,c)).data}catch(r){throw console.error("Lỗi khi upload:",((V=r.response)==null?void 0:V.data)||r.message),r}},async getAll(){return(await $.get(E)).data},async getById(h){return(await $.get(`${E}/${h}`)).data},async update(h,y){return(await $.put(`${E}/${h}`,y)).data},async deleteMedia(h){return(await $.delete(`${E}/${h}`)).data},async deleteByIdMedia(h){if(!h)throw new Error("idMedia là bắt buộc");return(await $.delete(`${E}/delete/${h}`)).data}},te={key:0,class:"dialog-overlay"},se={class:"dialog"},oe={class:"dialog-header"},le={class:"dialog-content"},re={class:"product-list"},he=["src","alt"],ce={class:"product-details"},ue={class:"product-name"},ge={class:"product-variant"},de={class:"product-quantity"},ve={class:"rating-section"},me={class:"star-rating"},pe={class:"debug-info"},Ce=["onClick"],fe={class:"comment-section"},Se=["id","onUpdate:modelValue","placeholder"],Pe={class:"debug-info"},Te={class:"media-upload"},ye=["onDragover","onDragenter","onDragleave","onDrop"],_e=["onChange"],ke={class:"media-preview"},we=["src"],De=["onClick"],be=["src"],$e=["onClick"],Me={class:"debug-info"},Re={class:"debug-info"},Ee={class:"media-upload"},Ve=["onDragover","onDragenter","onDragleave","onDrop"],Le=["onChange"],Ue={class:"media-preview"},Be=["src"],Oe=["onClick"],xe=["src"],Ge=["onClick"],je={class:"debug-info"},ze={class:"debug-info"},Ae={class:"dialog-footer"},Fe=["disabled"],Ne=5*1024*1024,qe=50*1024*1024,O=5,x=2,Xe={__name:"DialogDanhGiaSao",props:{isOpen:Boolean,orderId:Number,orderProducts:Array,idSanPhamChiTietList:Array,isEditing:Boolean,existingRatingData:Object},emits:["close","submit"],setup(h,{emit:y}){const c=h,V=y,r=I();S(JSON.parse(localStorage.getItem("user"))||null);const C=S({}),_=S({}),g=S({}),v=S({}),d=S({}),m=S({}),w=S(!1),D=S({}),b=S({}),u=S({}),f=S({});q(()=>[c.isEditing,c.existingRatingData],([i,a])=>{console.log("Watch triggered:",{newIsEditing:i,newRatingData:a}),C.value={},_.value={},g.value={},v.value={},d.value={},m.value={},u.value={},f.value={},i&&a?(a.forEach(e=>{const n=e.idSanPhamChiTiet;C.value[n]=e.soSao,_.value[n]=e.noiDung||"",u.value[n]=e.media||[],f.value[n]=[]}),console.log("State after watch:",{productRatings:C.value,productComments:_.value,existingMedia:u.value,deletedMediaIds:f.value})):(console.log("Reset state for create mode"),c.orderProducts.forEach(e=>{const n=e.idSanPhamChiTiet;C.value[n]=0,_.value[n]="",g.value[n]=[],v.value[n]=[],d.value[n]=[],m.value[n]=[],u.value[n]=[],f.value[n]=[],D.value[n]=!1,b.value[n]=!1}))},{immediate:!0,deep:!0}),q(()=>c,i=>{var a;console.log("Props nhận được:",{isOpen:i.isOpen,orderId:i.orderId,isEditing:i.isEditing,orderProducts:(a=i.orderProducts)==null?void 0:a.map((e,n)=>({index:n,idSanPhamChiTiet:e.idSanPhamChiTiet,idChiTietHoaDon:e.idChiTietHoaDon,tenSanPham:e.tenSanPham})),existingRatingData:i.existingRatingData}),(!i.orderProducts||!Array.isArray(i.orderProducts))&&(console.error("Lỗi: orderProducts không hợp lệ",{orderProducts:i.orderProducts}),r.error("Dữ liệu sản phẩm không hợp lệ!"))},{immediate:!0,deep:!0});const X=(i,a)=>{if(console.log("setRating gọi với:",{productId:i,value:a}),!c.orderProducts.find(n=>n.idSanPhamChiTiet===i)){console.error(`ID sản phẩm chi tiết không hợp lệ: ${i}`),r.error(`ID sản phẩm chi tiết không hợp lệ: ${i}`);return}C.value={...C.value,[i]:a},console.log("productRatings sau khi set:",C.value)},G=(i,a)=>{var s;console.log("handleImageUpload được gọi cho productId:",a);const e=i.target.files||((s=i.dataTransfer)==null?void 0:s.files);if(!e||e.length===0){console.warn("Không có file nào được chọn hoặc kéo thả"),r.warning("Vui lòng chọn hoặc kéo thả ít nhất một ảnh!");return}const n=Array.from(e);if(console.log("Danh sách file ảnh:",n.map(l=>({name:l.name,size:l.size,type:l.type}))),(g.value[a]||[]).length+(u.value[a]||[]).filter(l=>l.type==="image").length+n.length>O){console.warn(`Vượt quá giới hạn ${O} ảnh cho sản phẩm ${a}!`),r.warning(`Bạn chỉ có thể tải lên tối đa ${O} ảnh cho sản phẩm này!`);return}const o=n.filter(l=>l.type.startsWith("image/")?l.size>Ne?(console.warn(`Ảnh vượt quá 5MB: ${l.name}`),r.warning(`Ảnh ${l.name} vượt quá 5MB!`),!0):["image/jpeg","image/png","image/webp"].includes(l.type)?(g.value[a]||[]).some(L=>L.name===l.name)?(console.warn(`Ảnh đã tồn tại: ${l.name}`),r.warning(`Ảnh ${l.name} đã được thêm trước đó!`),!0):!1:(console.warn(`Ảnh không đúng định dạng JPG/PNG: ${l.name}`),r.warning(`Ảnh ${l.name} phải có định dạng JPG hoặc PNG!`),!0):(console.warn(`Tệp không phải ảnh: ${l.name}`),r.warning(`Tệp ${l.name} không phải là ảnh!`),!0));if(o.length>0){console.warn("Có file không hợp lệ, dừng xử lý:",o.map(l=>l.name));return}n.forEach(l=>{const L=URL.createObjectURL(l);g.value[a]=[...g.value[a]||[],l],v.value[a]=[...v.value[a]||[],{file:l,url:L}],console.log(`Thêm ảnh cho productId ${a}: ${l.name}, URL: ${L}`)}),g.value={...g.value}},j=(i,a)=>{var o;console.log("handleVideoUpload được gọi cho productId:",a);const e=Array.from(i.target.files||((o=i.dataTransfer)==null?void 0:o.files));if(console.log("Danh sách file video:",e.map(s=>({name:s.name,size:s.size,type:s.type}))),(d.value[a]||[]).length+(u.value[a]||[]).filter(s=>s.type==="video").length+e.length>x){console.warn(`Vượt quá giới hạn ${x} video cho sản phẩm ${a}!`),r.warning(`Bạn chỉ có thể tải lên tối đa ${x} video cho sản phẩm này!`);return}const n=e.filter(s=>s.type.startsWith("video/")?s.size>qe?(console.warn(`Video vượt quá 50MB: ${s.name}`),r.warning(`Video ${s.name} vượt quá 50MB!`),!0):["video/mp4","video/webm"].includes(s.type)?(d.value[a]||[]).some(l=>l.name===s.name)?(console.warn(`Video đã tồn tại: ${s.name}`),r.warning(`Video ${s.name} đã được thêm trước đó!`),!0):!1:(console.warn(`Video không đúng định dạng MP4/WebM: ${s.name}`),r.warning(`Video ${s.name} phải có định dạng MP4 hoặc WebM!`),!0):(console.warn(`Tệp không phải video: ${s.name}`),r.warning(`Tệp ${s.name} không phải là video!`),!0));if(n.length>0){console.warn("Có file không hợp lệ, dừng xử lý:",n.map(s=>s.name));return}e.forEach(s=>{const l=URL.createObjectURL(s);d.value[a]=[...d.value[a]||[],s],m.value[a]=[...m.value[a]||[],{file:s,url:l}],console.log(`Thêm video cho productId ${a}: ${s.name}, URL: ${l}`)})},z=(i,a,e)=>{i.preventDefault(),a==="image"?D.value[e]=!0:b.value[e]=!0},A=(i,a,e)=>{i.preventDefault(),a==="image"?D.value[e]=!0:b.value[e]=!0},F=(i,a,e)=>{i.preventDefault(),a==="image"?D.value[e]=!1:b.value[e]=!1},H=(i,a)=>{D.value[a]=!1,G(i,a)},K=(i,a)=>{b.value[a]=!1,j(i,a)},J=(i,a)=>{var e;console.log(`Xóa ảnh tại index ${a} cho productId ${i}:`,(e=g.value[i][a])==null?void 0:e.name),URL.revokeObjectURL(v.value[i][a].url),g.value[i].splice(a,1),v.value[i].splice(a,1),g.value={...g.value},v.value={...v.value}},W=(i,a)=>{var e;console.log(`Xóa video tại index ${a} cho productId ${i}:`,(e=d.value[i][a])==null?void 0:e.name),URL.revokeObjectURL(m.value[i][a].url),d.value[i].splice(a,1),m.value[i].splice(a,1),d.value={...d.value},m.value={...m.value}},N=(i,a)=>{var e;console.log(`Đánh dấu xóa media với id ${a} cho productId ${i}:`,(e=u.value[i].find(n=>n.id===a))==null?void 0:e.url),u.value[i]=u.value[i].filter(n=>n.id!==a),f.value[i]=[...f.value[i]||[],a],u.value={...u.value},f.value={...f.value},console.log(`Updated deletedMediaIds for productId ${i}:`,f.value[i])},U=()=>{console.log("closeDialog được gọi"),Object.keys(v.value).forEach(i=>{v.value[i].forEach(a=>{var e;console.log(`Thu hồi URL ảnh cho productId ${i}: ${(e=a.file)==null?void 0:e.name}`),URL.revokeObjectURL(a.url)})}),Object.keys(m.value).forEach(i=>{m.value[i].forEach(a=>{var e;console.log(`Thu hồi URL video cho productId ${i}: ${(e=a.file)==null?void 0:e.name}`),URL.revokeObjectURL(a.url)})}),C.value={},_.value={},g.value={},v.value={},d.value={},m.value={},u.value={},f.value={},D.value={},b.value={},V("close")},Z=async()=>{console.log("submitRating (mới) được gọi:",{propsIsEditing:c.isEditing,productRatings:C.value,productComments:_.value,imageFiles:Object.keys(g.value).reduce((e,n)=>({...e,[n]:g.value[n].map(o=>({name:o.name,size:o.size,type:o.type}))}),{}),videoFiles:Object.keys(d.value).reduce((e,n)=>({...e,[n]:d.value[n].map(o=>({name:o.name,size:o.size,type:o.type}))}),{}),existingMedia:u.value,deletedMediaIds:f.value});const i=c.idSanPhamChiTietList.map(e=>{var s;if(!c.orderProducts.find(l=>l.idSanPhamChiTiet===e.idSanPhamChiTiet))return console.error(`Không tìm thấy sản phẩm với idSanPhamChiTiet: ${e.idSanPhamChiTiet}`),null;const o=(s=c.existingRatingData)==null?void 0:s.find(l=>l.idSanPhamChiTiet===e.idSanPhamChiTiet);return{idSanPhamChiTiet:e.idSanPhamChiTiet,idChiTietHoaDon:e.idChiTietHoaDon,soSao:C.value[e.idSanPhamChiTiet],noiDung:_.value[e.idSanPhamChiTiet]||"",imageFiles:g.value[e.idSanPhamChiTiet]||[],videoFiles:d.value[e.idSanPhamChiTiet]||[],existingMedia:u.value[e.idSanPhamChiTiet]||[],idDanhGia:(o==null?void 0:o.idDanhGia)||null,deletedMediaIds:f.value[e.idSanPhamChiTiet]||[]}}).filter(e=>e!==null);console.log("Ratings được tạo:",JSON.stringify(i,null,2));const a=i.filter(e=>!e.soSao||e.soSao<1||e.soSao>5);if(i.length===0||a.length>0){console.warn("Không có đánh giá hợp lệ hoặc chưa đánh giá sản phẩm"),r.error("Vui lòng chọn số sao (1-5) cho tất cả sản phẩm!"),w.value=!1;return}if(c.isEditing&&i.some(n=>!n.idDanhGia)){console.error("Một số đánh giá thiếu idDanhGia trong chế độ chỉnh sửa:",i),r.error("Không thể cập nhật vì thiếu thông tin đánh giá hiện có!"),w.value=!1;return}try{await ie.confirm(c.isEditing?"Bạn có chắc chắn muốn cập nhật đánh giá này không?":"Bạn có chắc chắn muốn gửi đánh giá này không?","Xác nhận đánh giá",{confirmButtonText:"Xác nhận",cancelButtonText:"Hủy",type:"warning"})}catch(e){console.log("Người dùng hủy gửi đánh giá",e),r.info("Thao tác gửi đánh giá đã bị hủy."),w.value=!1;return}w.value=!0;try{const e={idHoaDon:c.orderId,ratings:i,trangThaiDanhGia:"APPROVED"};console.log("Payload gửi đi:",JSON.stringify(e,null,2)),await V("submit",{payload:e}),r.success(c.isEditing?"Cập nhật đánh giá thành công!":"Gửi đánh giá thành công!"),U()}catch(e){console.error("Lỗi khi gửi đánh giá:",e);let n="Gửi đánh giá thất bại. Vui lòng thử lại.";if(e.response){const{status:o,data:s}=e.response;console.error("Chi tiết lỗi từ backend:",{status:o,data:s}),o===400?n=s.message||"Dữ liệu gửi lên không hợp lệ. Vui lòng kiểm tra lại.":o===401?n="Vui lòng đăng nhập để gửi đánh giá.":o===403?n="Bạn không có quyền gửi đánh giá cho đơn hàng này.":o===409?n="Đánh giá cho sản phẩm này đã tồn tại.":o===413?n="Tệp tải lên quá lớn. Vui lòng chọn tệp nhỏ hơn.":o>=500&&(n="Lỗi hệ thống. Vui lòng thử lại sau.")}else e.request&&(n="Không thể kết nối đến server. Vui lòng kiểm tra kết nối mạng.");r.error(n)}finally{w.value=!1}};return(i,a)=>h.isOpen?(T(),P("div",te,[t("div",se,[t("div",oe,[t("h2",null,p(h.isEditing?"Sửa đánh giá đơn hàng":"Đánh giá đơn hàng")+" #"+p(h.orderId),1),t("button",{class:"close-button",onClick:U},"✖")]),t("div",le,[t("div",re,[a[6]||(a[6]=t("h3",null,"Sản phẩm",-1)),(T(!0),P(M,null,R(h.orderProducts,e=>(T(),P("div",{key:e.idSanPhamChiTiet,class:"product-item"},[t("img",{src:e.urlImage,alt:e.tenSanPham,class:"product-image"},null,8,he),t("div",ce,[t("div",ue,p(e.tenSanPham),1),t("div",ge,"Phân loại: "+p(e.colorName)+" "+p(e.dungLuongRom),1),t("div",de,"x"+p(e.soLuong),1),t("div",ve,[a[0]||(a[0]=t("label",{class:"label"},"Đánh giá:",-1)),t("div",me,[t("span",pe,"Rating: "+p(C.value[e.idSanPhamChiTiet]||"Chưa chọn"),1),(T(),P(M,null,R(5,n=>t("span",{key:n,class:B(["star",{filled:n<=C.value[e.idSanPhamChiTiet]}]),onClick:o=>X(e.idSanPhamChiTiet,n)}," ★ ",10,Ce)),64))])]),t("div",fe,[a[1]||(a[1]=t("label",{class:"label"},"Bình luận:",-1)),ne(t("textarea",{id:"comment-"+e.idSanPhamChiTiet,"onUpdate:modelValue":n=>_.value[e.idSanPhamChiTiet]=n,class:"text-input",rows:"4",placeholder:"Nhập nhận xét cho "+e.tenSanPham},null,8,Se),[[ae,_.value[e.idSanPhamChiTiet]]]),t("span",Pe,"Comment: "+p(_.value[e.idSanPhamChiTiet]||"Trống"),1)]),t("div",Te,[a[3]||(a[3]=t("label",{class:"label"},"Tải lên ảnh (tối đa 5):",-1)),t("div",{class:B(["drop-zone",{"drag-over":D.value[e.idSanPhamChiTiet]}]),onDragover:k(n=>z(n,"image",e.idSanPhamChiTiet),["prevent"]),onDragenter:k(n=>A(n,"image",e.idSanPhamChiTiet),["prevent"]),onDragleave:k(n=>F(n,"image",e.idSanPhamChiTiet),["prevent"]),onDrop:k(n=>H(n,e.idSanPhamChiTiet),["prevent"])},[a[2]||(a[2]=t("div",{class:"drop-zone-content"},[t("svg",{class:"upload-icon",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor"},[t("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M7 16V8m0 0l-4 4m4-4l4 4m6 4v-6a2 2 0 00-2-2h-6m-4 4h12"})]),t("p",null,"Kéo và thả ảnh vào đây hoặc nhấp để chọn (JPG, PNG, tối đa 5MB)")],-1)),t("input",{type:"file",accept:"image/jpeg,image/png,image/webp",multiple:"",onChange:n=>G(n,e.idSanPhamChiTiet),class:"file-input"},null,40,_e)],42,ye),t("div",ke,[(T(!0),P(M,null,R((u.value[e.idSanPhamChiTiet]||[]).filter(n=>n.type==="image"),(n,o)=>(T(),P("div",{key:"existing-image-"+n.id,class:"preview-item"},[t("img",{src:n.url,class:"preview-image"},null,8,we),t("button",{class:"remove-media",onClick:s=>N(e.idSanPhamChiTiet,n.id)},"✖",8,De)]))),128)),(T(!0),P(M,null,R(v.value[e.idSanPhamChiTiet]||[],(n,o)=>(T(),P("div",{key:"new-image-"+o,class:"preview-item"},[t("img",{src:n.url,class:"preview-image"},null,8,be),t("button",{class:"remove-media",onClick:s=>J(e.idSanPhamChiTiet,o)},"✖",8,$e)]))),128)),t("span",Me,"Existing Images: "+p((u.value[e.idSanPhamChiTiet]||[]).filter(n=>n.type==="image").length)+" items",1),t("span",Re,"New Images: "+p((v.value[e.idSanPhamChiTiet]||[]).length)+" items",1)])]),t("div",Ee,[a[5]||(a[5]=t("label",{class:"label"},"Tải lên video (tối đa 2):",-1)),t("div",{class:B(["drop-zone",{"drag-over":b.value[e.idSanPhamChiTiet]}]),onDragover:k(n=>z(n,"video",e.idSanPhamChiTiet),["prevent"]),onDragenter:k(n=>A(n,"video",e.idSanPhamChiTiet),["prevent"]),onDragleave:k(n=>F(n,"video",e.idSanPhamChiTiet),["prevent"]),onDrop:k(n=>K(n,e.idSanPhamChiTiet),["prevent"])},[a[4]||(a[4]=t("div",{class:"drop-zone-content"},[t("svg",{class:"upload-icon",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor"},[t("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M7 16V8m0 0l-4 4m4-4l4 4m6 4v-6a2 2 0 00-2-2h-6m-4 4h12"})]),t("p",null,"Kéo và thả video vào đây hoặc nhấp để chọn (MP4, WebM, tối đa 50MB)")],-1)),t("input",{type:"file",accept:"video/mp4,video/webm",multiple:"",onChange:n=>j(n,e.idSanPhamChiTiet),class:"file-input"},null,40,Le)],42,Ve),t("div",Ue,[(T(!0),P(M,null,R((u.value[e.idSanPhamChiTiet]||[]).filter(n=>n.type==="video"),(n,o)=>(T(),P("div",{key:"existing-video-"+n.id,class:"preview-item"},[t("video",{src:n.url,controls:"",class:"preview-video"},null,8,Be),t("button",{class:"remove-media",onClick:s=>N(e.idSanPhamChiTiet,n.id)},"✖",8,Oe)]))),128)),(T(!0),P(M,null,R(m.value[e.idSanPhamChiTiet]||[],(n,o)=>(T(),P("div",{key:"new-video-"+o,class:"preview-item"},[t("video",{src:n.url,controls:"",class:"preview-video"},null,8,xe),t("button",{class:"remove-media",onClick:s=>W(e.idSanPhamChiTiet,o)},"✖",8,Ge)]))),128)),t("span",je,"Existing Videos: "+p((u.value[e.idSanPhamChiTiet]||[]).filter(n=>n.type==="video").length)+" items",1),t("span",ze,"New Videos: "+p((m.value[e.idSanPhamChiTiet]||[]).length)+" items",1)])])])]))),128))]),t("div",Ae,[t("button",{class:"button primary-button",disabled:w.value,onClick:Z},p(w.value?"Đang gửi...":h.isEditing?"Cập nhật đánh giá":"Gửi đánh giá"),9,Fe),t("button",{class:"button outline-button",onClick:U},"Hủy")])])])])):ee("",!0)}},Ze=Y(Xe,[["__scopeId","data-v-8627ea8b"]]);export{We as M,Ze as R,Je as S};
