import{_ as Va,r as h,T as Ca,c as ia,a1 as ka,w as Ia,o as Ka,a as c,a2 as Ra,b as Y,d as f,e as i,f as e,B as L,k as F,i as n,h as d,j as w,L as La,s as Aa,am as Na,v as Ea,t as u,aN as sa,ao as Ya,a6 as Ma,F as X,m as O,E as m,G as q,R as ra}from"./index-BFtI-PwE.js";import{g as xa,i as za,u as $a,a as Ua}from"./BaoHanhService-DOw5Bu6j.js";import{c as Wa}from"./KhachHangServices-DSZDVUWy.js";import{l as Sa}from"./LoaiBaoHanhService-DrQv7Whi.js";const Fa={class:"warranty-container"},Xa={class:"page-header"},Oa={class:"header-content"},qa={class:"filters-content"},Ga={class:"filter-group"},ja={class:"filter-item"},Pa={class:"filter-item"},Qa={class:"filter-item"},Ja={class:"filter-item"},Za={class:"filter-actions"},ae={class:"row-index"},ee={class:"code-cell"},le={class:"code-cell"},te={class:"code-cell"},ne={class:"name-cell"},oe={class:"warranty-name"},ie={class:"value-cell"},se={class:"warranty-time"},re={class:"date-range"},ue={class:"date-item"},he={class:"date-item"},de={class:"action-buttons"},ce={class:"pagination-wrapper"},ge={class:"form-grid"},ve={class:"form-row"},me={class:"form-row"},pe={class:"form-row"},fe={class:"dialog-footer"},_e={key:0,class:"detail-content"},be={class:"dialog-footer"},ye={__name:"BaoHanhAdmin",setup(Be){const V=h(""),C=h(""),k=h(null),M=h(null),$=h(!1),G=h([]),p=h(null),U=Ca({}),v=h({page:1,size:10,total:0}),I=h(!1),x=h(!1),_=h(!1),A=h(!1),D=h(null),o=h({idBaoHanh:null,idKhachHang:null,idImeiDaBan:null,idLoaiBaoHanh:null,ngayBatDau:"",ngayKetThuc:"",trangThaiBaoHanh:"UNDER_WARRANTY"}),W=h([]),K=h([]),T=h([]),ua=h({idKhachHang:[{required:!0,message:"Khách hàng không được để trống",trigger:"change"}],idImeiDaBan:[{required:!0,message:"IMEI đã bán không được để trống",trigger:"change"}],idLoaiBaoHanh:[{required:!0,message:"Loại bảo hành không được để trống",trigger:"change"}],ngayBatDau:[{required:!0,message:"Ngày bắt đầu không được để trống",trigger:"change"},{validator:(t,a,r)=>{a&&new Date(a)>new Date?r(new Error("Ngày bắt đầu phải nhỏ hơn hoặc bằng ngày hiện tại")):r()},trigger:"change"}],trangThaiBaoHanh:[{required:!0,message:"Trạng thái bảo hành không được để trống",trigger:"change"}]}),j=ia(()=>{const t=ka.state.roles;return Array.isArray(t)&&t.map(a=>typeof a=="string"?a:a.authority).includes("ROLE_ADMIN")}),ha=ia(()=>A.value?"Cập nhật bảo hành":"Thêm bảo hành mới"),b=async()=>{var t,a,r;$.value=!0;try{console.log("Fetching warranty list with params:",{search:V.value,trangThai:C.value,ngayBatDau:k.value,page:v.value.page-1,size:v.value.size});const s=await xa({search:V.value,trangThai:C.value,ngayBatDau:k.value,page:v.value.page-1,size:v.value.size});console.log("Fetch response:",s),G.value=s.content||[],v.value.total=s.totalElements||0}catch(s){if(console.error("Fetch error:",s),console.error("Fetch error details:",{response:s.response,data:(t=s.response)==null?void 0:t.data,status:(a=s.response)==null?void 0:a.status}),((r=s.response)==null?void 0:r.status)===400&&s.response.data){let R="Lỗi khi tải danh sách bảo hành: ";s.response.data&&typeof s.response.data=="object"&&(Object.keys(s.response.data).forEach(g=>{Array.isArray(s.response.data[g])&&s.response.data[g].forEach(H=>{H.message&&(R+=`${g}: ${H.message}; `)})}),console.warn("Validation error in fetch:",R))}else m.error((s==null?void 0:s.message)||"Lỗi khi lấy danh sách bảo hành")}finally{$.value=!1}},P=async()=>{try{const t=await Wa();W.value=t.content||t||[]}catch(t){console.error("Load dropdown error:",t),m.error("Lỗi khi tải dữ liệu dropdown")}},Q=async t=>{if(o.value.idImeiDaBan=null,o.value.idLoaiBaoHanh=null,T.value=[],t)try{const a=await za(t);a&&a.length>0?K.value=a:(K.value=[],m.error("Khách hàng chưa mua sản phẩm nào"))}catch(a){console.error("Load IMEI error:",a),m.error("Lỗi khi tải danh sách IMEI"),K.value=[]}else K.value=[]},J=async t=>{if(o.value.idLoaiBaoHanh=null,t)try{const a=await Sa(t);a&&a.length>0?T.value=a||a:(T.value=[],m.error("Sản phẩm này chưa có loại bảo hành"))}catch(a){console.error("Load warranty types error:",a),m.error("Lỗi khi tải dữ liệu dropdown"),T.value=[]}else T.value=[]},da=()=>{Z()},Z=()=>{if(o.value.ngayBatDau&&o.value.idLoaiBaoHanh){const t=T.value.find(a=>a.id===o.value.idLoaiBaoHanh);if(t&&t.thoiGianThang){const a=new Date(o.value.ngayBatDau),r=new Date(a);r.setMonth(r.getMonth()+t.thoiGianThang);const s=r.getFullYear(),R=String(r.getMonth()+1).padStart(2,"0"),g=String(r.getDate()).padStart(2,"0");o.value.ngayKetThuc=`${s}-${R}-${g}`}}},ca=async()=>{A.value=!1,aa(),await P(),I.value=!0},ga=async t=>{A.value=!0,I.value=!0,await P(),t.idKhachHang&&await Q(t.idKhachHang),t.idImeiDaBan&&await J(t.idImeiDaBan),await q(),o.value={idBaoHanh:t.idBaoHanh,idKhachHang:t.idKhachHang,idImeiDaBan:t.idImeiDaBan,idLoaiBaoHanh:t.idLoaiBaoHanh,ngayBatDau:t.ngayBatDau,ngayKetThuc:t.ngayKetThuc,trangThaiBaoHanh:t.trangThaiBaoHanh},await q(),D.value&&D.value.clearValidate()},va=t=>{p.value=t,x.value=!0},aa=()=>{o.value={idBaoHanh:null,idKhachHang:null,idImeiDaBan:null,idLoaiBaoHanh:null,ngayBatDau:"",ngayKetThuc:"",trangThaiBaoHanh:"UNDER_WARRANTY"},K.value=[],q(()=>{D.value&&D.value.clearValidate()})},ma=async()=>{if(Object.keys(U).forEach(t=>delete U[t]),!!D.value){if(W.value.length===0||T.value.length===0){m.error("Đang tải dữ liệu, vui lòng đợi...");return}_.value=!0;try{if(!await D.value.validate().catch(()=>!1)){_.value=!1;return}if(console.log("Form values before submit:",{idKhachHang:o.value.idKhachHang,idImeiDaBan:o.value.idImeiDaBan,idLoaiBaoHanh:o.value.idLoaiBaoHanh,ngayBatDau:o.value.ngayBatDau,ngayKetThuc:o.value.ngayKetThuc,trangThaiBaoHanh:o.value.trangThaiBaoHanh}),!o.value.idKhachHang){m.error("Vui lòng chọn khách hàng"),_.value=!1;return}if(!o.value.idImeiDaBan){m.error("Vui lòng chọn IMEI đã bán"),_.value=!1;return}if(!o.value.idLoaiBaoHanh){m.error("Vui lòng chọn loại bảo hành"),_.value=!1;return}if(!o.value.ngayBatDau){m.error("Vui lòng chọn ngày bắt đầu"),_.value=!1;return}if(!o.value.trangThaiBaoHanh){m.error("Vui lòng chọn trạng thái bảo hành"),_.value=!1;return}const a={idKhachHang:Number(o.value.idKhachHang),idImeiDaBan:Number(o.value.idImeiDaBan),idLoaiBaoHanh:Number(o.value.idLoaiBaoHanh),ngayBatDau:o.value.ngayBatDau,ngayKetThuc:o.value.ngayKetThuc,trangThaiBaoHanh:o.value.trangThaiBaoHanh};console.log("Final payload to submit:",a),A.value?(await ra.confirm("Bạn có chắc chắn muốn cập nhật bảo hành này?","Xác nhận",{confirmButtonText:"Đồng ý",cancelButtonText:"Hủy",type:"warning"}),a.idBaoHanh=Number(o.value.idBaoHanh),console.log("Updating warranty with id:",o.value.idBaoHanh),await $a(o.value.idBaoHanh,a),m.success("Cập nhật bảo hành thành công")):(await ra.confirm("Bạn có chắc chắn muốn thêm bảo hành này?","Xác nhận",{confirmButtonText:"Đồng ý",cancelButtonText:"Hủy",type:"warning"}),console.log("Creating new warranty..."),await Ua(a),m.success("Thêm bảo hành thành công")),I.value=!1,setTimeout(()=>{b()},500)}catch(t){if(t==="cancel"||t==="close")return;console.error("Submit error:",t),Array.isArray(t)&&t.forEach(({field:a,message:r})=>{U[a]=r,m.error(r)});return}finally{_.value=!1}}},pa=()=>{V.value="",C.value="",k.value=null,M.value=null,v.value.page=1,b()},fa=t=>{v.value.page=t,b()},_a=t=>{v.value.size=t,v.value.page=1,b()},z=t=>t?new Date(t).toLocaleDateString("vi-VN"):"",ea=t=>({UNDER_WARRANTY:"Còn bảo hành",WARRANTY_EXPIRED:"Hết bảo hành",WARRANTY_VOID:"Không bảo hành"})[t]||"Không xác định",la=t=>({UNDER_WARRANTY:"success",WARRANTY_EXPIRED:"danger",WARRANTY_VOID:"info"})[t]||"info",ba=({rowIndex:t})=>t%2===0?"even-row":"odd-row";return Ia([V,C,k,M],()=>{v.value.page=1},{deep:!0}),Ka(()=>{b()}),(t,a)=>{const r=c("el-icon"),s=c("el-button"),R=c("el-input"),g=c("el-option"),H=c("el-select"),S=c("el-date-picker"),ta=c("el-card"),y=c("el-table-column"),N=c("el-tag"),na=c("el-tooltip"),ya=c("el-table"),Ba=c("el-pagination"),E=c("el-form-item"),Ta=c("el-form"),oa=c("el-dialog"),B=c("el-descriptions-item"),Ha=c("el-descriptions"),Da=Ra("loading");return f(),Y("div",Fa,[i("div",Xa,[i("div",Oa,[a[15]||(a[15]=i("div",{class:"title-section"},[i("h1",{class:"page-title"},"Quản lý bảo hành"),i("p",{class:"page-subtitle"},"Tạo và quản lý các chương trình bảo hành")],-1)),j.value?(f(),L(s,{key:0,type:"primary",size:"large",class:"create-btn",onClick:a[0]||(a[0]=l=>ca())},{default:n(()=>[e(r,{class:"btn-icon"},{default:n(()=>[e(w(La))]),_:1}),a[14]||(a[14]=d(" Thêm bảo hành "))]),_:1})):F("",!0)])]),e(ta,{class:"filters-card",shadow:"never"},{default:n(()=>[i("div",qa,[i("div",Ga,[i("div",ja,[a[16]||(a[16]=i("label",{class:"filter-label"},"Tìm kiếm",-1)),e(R,{modelValue:V.value,"onUpdate:modelValue":a[1]||(a[1]=l=>V.value=l),placeholder:"Tìm kiếm theo mã hoặc tên...",clearable:"",class:"filter-input",onInput:b},{prefix:n(()=>[e(r,{class:"search-icon"},{default:n(()=>[e(w(Aa))]),_:1})]),_:1},8,["modelValue"])]),i("div",Pa,[a[17]||(a[17]=i("label",{class:"filter-label"},"Trạng thái",-1)),e(H,{modelValue:C.value,"onUpdate:modelValue":a[2]||(a[2]=l=>C.value=l),placeholder:"Chọn trạng thái",clearable:"",class:"filter-select",onChange:b},{default:n(()=>[e(g,{label:"Tất cả",value:""}),e(g,{label:"Còn bảo hành",value:"UNDER_WARRANTY"}),e(g,{label:"Hết bảo hành",value:"WARRANTY_EXPIRED"}),e(g,{label:"Không bảo hành",value:"WARRANTY_VOID"})]),_:1},8,["modelValue"])]),i("div",Qa,[a[18]||(a[18]=i("label",{class:"filter-label"},"Thời gian bắt đầu",-1)),e(S,{modelValue:k.value,"onUpdate:modelValue":a[3]||(a[3]=l=>k.value=l),type:"date",placeholder:"Chọn thời gian bắt đầu","value-format":"YYYY-MM-DD",clearable:"",class:"filter-date",onChange:b},null,8,["modelValue"])]),i("div",Ja,[a[19]||(a[19]=i("label",{class:"filter-label"},"Thời gian kết thúc",-1)),e(S,{modelValue:M.value,"onUpdate:modelValue":a[4]||(a[4]=l=>M.value=l),type:"date",placeholder:"Chọn thời gian kết thúc","value-format":"YYYY-MM-DD",clearable:"",class:"filter-date",onChange:b},null,8,["modelValue"])]),i("div",Za,[e(s,{onClick:pa,class:"reset-btn"},{default:n(()=>[e(r,null,{default:n(()=>[e(w(Na))]),_:1}),a[20]||(a[20]=d(" Làm mới "))]),_:1})])])])]),_:1}),e(ta,{class:"table-card",shadow:"never"},{default:n(()=>[Ea((f(),L(ya,{data:G.value,class:"warranty-table","row-class-name":ba,"empty-text":"Không có dữ liệu"},{default:n(()=>[e(y,{label:"STT",width:"75",align:"center"},{default:n(l=>[i("span",ae,u(l.$index+1+(v.value.page-1)*v.value.size),1)]),_:1}),e(y,{prop:"soImeiDaBan",label:"Số IMEI","min-width":"150"},{default:n(l=>[i("div",ee,[e(N,{type:"success",size:"small",class:"code-tag"},{default:n(()=>[d(u(l.row.soImeiDaBan),1)]),_:2},1024)])]),_:1}),e(y,{prop:"tenLoaiBaoHanh",label:"Loại bảo hành","min-width":"170"},{default:n(l=>[i("div",le,[e(N,{type:"info",size:"small",class:"code-tag"},{default:n(()=>[d(u(l.row.tenLoaiBaoHanh),1)]),_:2},1024)])]),_:1}),e(y,{prop:"maKhachHang",label:"Mã khách hàng","min-width":"120"},{default:n(l=>[i("div",te,[e(N,{type:"warning",size:"small",class:"code-tag"},{default:n(()=>[d(u(l.row.maKhachHang),1)]),_:2},1024)])]),_:1}),e(y,{prop:"tenKhachHang",label:"Tên khách hàng","min-width":"150"},{default:n(l=>[i("div",ne,[i("span",oe,u(l.row.tenKhachHang),1)])]),_:1}),e(y,{label:"Thời gian (tháng)",width:"140",align:"center"},{default:n(l=>[i("div",ie,[i("span",se,u(l.row.thoiGianThang)+" tháng",1)])]),_:1}),e(y,{label:"Thời gian bảo hành",width:"200"},{default:n(l=>[i("div",re,[i("div",ue,[e(r,{class:"date-icon"},{default:n(()=>[e(w(sa))]),_:1}),i("span",null,u(z(l.row.ngayBatDau)),1)]),a[21]||(a[21]=i("div",{class:"date-separator"},"→",-1)),i("div",he,[e(r,{class:"date-icon"},{default:n(()=>[e(w(sa))]),_:1}),i("span",null,u(z(l.row.ngayKetThuc)),1)])])]),_:1}),e(y,{label:"Trạng thái",width:"150",align:"center"},{default:n(l=>[e(N,{type:la(l.row.trangThaiBaoHanh),size:"small"},{default:n(()=>[d(u(ea(l.row.trangThaiBaoHanh)),1)]),_:2},1032,["type"])]),_:1}),e(y,{label:"Thao tác",width:"200",align:"center",fixed:"right"},{default:n(l=>[i("div",de,[e(na,{content:"Xem chi tiết",placement:"top"},{default:n(()=>[e(s,{size:"small",type:"info",icon:w(Ya),circle:"",onClick:wa=>va(l.row),class:"action-btn view-btn"},null,8,["icon","onClick"])]),_:2},1024),e(na,{content:"Chỉnh sửa",placement:"top"},{default:n(()=>[j.value?(f(),L(s,{key:0,size:"small",type:"primary",icon:w(Ma),circle:"",onClick:wa=>ga(l.row),class:"action-btn edit-btn"},null,8,["icon","onClick"])):F("",!0)]),_:2},1024)])]),_:1})]),_:1},8,["data"])),[[Da,$.value]]),i("div",ce,[e(Ba,{background:"",layout:"total, sizes, prev, pager, next, jumper","current-page":v.value.page,"page-size":v.value.size,"page-sizes":[5,10,20,50],total:v.value.total,onCurrentChange:fa,onSizeChange:_a,class:"custom-pagination"},null,8,["current-page","page-size","total"])])]),_:1}),e(oa,{modelValue:I.value,"onUpdate:modelValue":a[11]||(a[11]=l=>I.value=l),title:ha.value,width:"700px",onClose:aa},{footer:n(()=>[i("div",fe,[e(s,{onClick:a[10]||(a[10]=l=>I.value=!1)},{default:n(()=>a[22]||(a[22]=[d("Hủy")])),_:1}),e(s,{type:"primary",onClick:ma,loading:_.value},{default:n(()=>[d(u(A.value?"Cập nhật":"Thêm mới"),1)]),_:1},8,["loading"])])]),default:n(()=>[e(Ta,{ref_key:"formRef",ref:D,model:o.value,rules:ua.value,"label-width":"150px","label-position":"top"},{default:n(()=>[i("div",ge,[i("div",ve,[e(E,{label:"Khách hàng",prop:"idKhachHang",class:"form-item"},{default:n(()=>[e(H,{modelValue:o.value.idKhachHang,"onUpdate:modelValue":a[5]||(a[5]=l=>o.value.idKhachHang=l),placeholder:"Chọn khách hàng",filterable:"",clearable:"",style:{width:"100%"},onChange:Q},{default:n(()=>[(f(!0),Y(X,null,O(W.value,l=>(f(),L(g,{key:l.id,label:`${l.maKhachHang} - ${l.tenKhachHang} - ${l.sdt}`,value:l.id},null,8,["label","value"]))),128))]),_:1},8,["modelValue"])]),_:1}),e(E,{label:"IMEI đã bán",prop:"idImeiDaBan",class:"form-item"},{default:n(()=>[e(H,{modelValue:o.value.idImeiDaBan,"onUpdate:modelValue":a[6]||(a[6]=l=>o.value.idImeiDaBan=l),placeholder:"Chọn IMEI",filterable:"",clearable:"",style:{width:"100%"},disabled:!o.value.idKhachHang,onChange:J},{default:n(()=>[(f(!0),Y(X,null,O(K.value,l=>(f(),L(g,{key:l.id,label:`${l.soImei} | ${l.tenModel} ${l.maXuatXu}`,value:l.id},null,8,["label","value"]))),128))]),_:1},8,["modelValue","disabled"])]),_:1})]),i("div",me,[e(E,{label:"Loại bảo hành",prop:"idLoaiBaoHanh",class:"form-item"},{default:n(()=>[e(H,{modelValue:o.value.idLoaiBaoHanh,"onUpdate:modelValue":a[7]||(a[7]=l=>o.value.idLoaiBaoHanh=l),placeholder:"Chọn loại bảo hành",filterable:"",clearable:"",style:{width:"100%"},disabled:!o.value.idImeiDaBan,onChange:da},{default:n(()=>[(f(!0),Y(X,null,O(T.value,l=>(f(),L(g,{key:l.id,label:`${l.tenLoaiBaoHanh} (${l.thoiGianThang} tháng) | ${l.daCo==!0?"Đã có":"Chưa có"}`,value:l.id},null,8,["label","value"]))),128))]),_:1},8,["modelValue","disabled"])]),_:1}),e(E,{label:"Trạng thái",prop:"trangThaiBaoHanh",class:"form-item"},{default:n(()=>[e(H,{modelValue:o.value.trangThaiBaoHanh,"onUpdate:modelValue":a[8]||(a[8]=l=>o.value.trangThaiBaoHanh=l),placeholder:"Chọn trạng thái",style:{width:"100%"}},{default:n(()=>[e(g,{label:"Còn bảo hành",value:"UNDER_WARRANTY"}),e(g,{label:"Hết bảo hành",value:"WARRANTY_EXPIRED"}),e(g,{label:"Không bảo hành",value:"WARRANTY_VOID"})]),_:1},8,["modelValue"])]),_:1})]),i("div",pe,[e(E,{label:"Ngày bắt đầu",prop:"ngayBatDau",class:"form-item"},{default:n(()=>[e(S,{modelValue:o.value.ngayBatDau,"onUpdate:modelValue":a[9]||(a[9]=l=>o.value.ngayBatDau=l),type:"date",placeholder:"Chọn ngày bắt đầu",style:{width:"100%"},"value-format":"YYYY-MM-DD",onChange:Z},null,8,["modelValue"])]),_:1})])])]),_:1},8,["model","rules"])]),_:1},8,["modelValue","title"]),e(oa,{modelValue:x.value,"onUpdate:modelValue":a[13]||(a[13]=l=>x.value=l),title:"Chi tiết bảo hành",width:"600px"},{footer:n(()=>[i("div",be,[e(s,{onClick:a[12]||(a[12]=l=>x.value=!1)},{default:n(()=>a[23]||(a[23]=[d("Đóng")])),_:1})])]),default:n(()=>[p.value?(f(),Y("div",_e,[e(Ha,{column:2,border:""},{default:n(()=>[e(B,{label:"Mã khách hàng"},{default:n(()=>[d(u(p.value.maKhachHang),1)]),_:1}),e(B,{label:"Tên khách hàng"},{default:n(()=>[d(u(p.value.tenKhachHang),1)]),_:1}),e(B,{label:"Số điện thoại khách hàng"},{default:n(()=>[d(u(p.value.sdtKhachHang),1)]),_:1}),e(B,{label:"Số IMEI"},{default:n(()=>[d(u(p.value.soImeiDaBan),1)]),_:1}),e(B,{label:"Loại bảo hành"},{default:n(()=>[d(u(p.value.tenLoaiBaoHanh),1)]),_:1}),e(B,{label:"Thời gian bảo hành"},{default:n(()=>[d(u(p.value.thoiGianThang)+" tháng ",1)]),_:1}),e(B,{label:"Trạng thái"},{default:n(()=>[e(N,{type:la(p.value.trangThaiBaoHanh)},{default:n(()=>[d(u(ea(p.value.trangThaiBaoHanh)),1)]),_:1},8,["type"])]),_:1}),e(B,{label:"Ngày bắt đầu",span:2},{default:n(()=>[d(u(z(p.value.ngayBatDau)),1)]),_:1}),e(B,{label:"Ngày kết thúc",span:2},{default:n(()=>[d(u(z(p.value.ngayKetThuc)),1)]),_:1})]),_:1})])):F("",!0)]),_:1},8,["modelValue"])])}}},Ve=Va(ye,[["__scopeId","data-v-5420bc71"]]);export{Ve as default};
