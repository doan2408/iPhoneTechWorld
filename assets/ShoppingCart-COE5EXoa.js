import{_ as te,r as k,H as se,I as oe,z as le,o as ie,J as ce,c as L,E as r,a as v,b as _,d as f,e as s,k as z,f as o,i,j as d,C as re,s as ue,K as he,h as M,L as K,F as $,m as ge,n as de,M as me,N as _e,t as h,O as fe,l as ve,P as ye,Q as pe,D as E,R as Le,S as q}from"./index-I05jmhuU.js";import{c as V}from"./GioHangClientService-C_rhNnUK.js";import{n as Se}from"./KhuyenMaiSanPhamService-B9L5aGWt.js";const Te={class:"shopping-cart-container"},Ce={class:"cart-header"},we={class:"header-content"},ke={class:"brand-section"},be={class:"brand-logo"},xe={class:"search-section"},Pe={key:0,class:"empty-cart"},Me={class:"empty-illustration"},Ve={key:1,class:"products-container"},Ie={class:"product-selection"},Ue={class:"product-image"},De={class:"image-error"},Be={key:0,class:"out-of-stock-badge"},Qe={class:"product-info"},Ge={class:"product-name"},He={class:"product-name"},Ne={class:"product-variant"},ze={class:"product-price"},Ke={style:{display:"flex",height:"90px","flex-direction":"column","justify-content":"space-around","align-items":"flex-end",gap:"4px"}},$e={class:"current-price"},Ee={class:"old-price"},qe={key:1,class:"current-price"},Oe={class:"product-quantity"},Je={class:"label"},Re={class:"quantity-controls"},Ae={class:"product-total"},je={class:"total-price"},Fe={class:"product-actions"},Xe={key:0,class:"checkout-section"},We={class:"checkout-container"},Ye={class:"checkout-left"},Ze={class:"checkout-right"},en={class:"checkout-summary"},nn={class:"summary-row"},an={class:"summary-total"},tn={__name:"ShoppingCart",setup(sn){const B=k(0),I=se();I.hasModule("headerState")||I.registerModule("headerState",oe);const Q=le(),G=Q.query.selected,S=k(""),T=k(!1),c=k([]),y=k(JSON.parse(localStorage.getItem("user"))||null),O=async()=>{try{const e=await Se();return Math.max(1e3,e.delay||6e4)}catch(e){return e.name!=="AbortError"&&(console.error("Không thể lấy thời gian cập nhật:",e),toast.error("Không thể lấy thời gian cập nhật")),6e4}};let b=null;ie(async()=>{await x(),window.scrollTo({top:0,left:0,behavior:"smooth"});const e=await O();b=setInterval(()=>{x()},e)}),ce(()=>{b&&(clearInterval(b),b=null)});const J=()=>{I.commit("headerState/setCartItemCount",B.value)};async function x(){var e,n;c.value=[];try{if((e=y.value)!=null&&e.id){const a=await V.getCart(y.value.id);c.value=a.items.map(l=>({idGioHangChiTiet:l.idGioHangChiTiet,idSanPhamChiTiet:l.idSanPhamChiTiet,maSanPhamChiTiet:l.maSanPhamChiTiet||"SPCT000",tenSanPham:l.tenSanPham||"Sản phẩm",phienBan:l.phienBan||"Mặc định",imageUrl:l.imageUrl||"",giaTruocKhuyenMai:l.giaTruocKhuyenMai||0,gia:l.gia||0,soLuong:l.soLuong||1,soLuongTon:l.soLuongTon||0,ngayThem:l.ngayThem||new Date().toISOString(),selected:!1}));try{B.value=await V.cartCount((n=y.value)==null?void 0:n.id)}catch(l){console.error("Lỗi khi tải giỏ hàng:",l)}J()}else{const a=localStorage.getItem("shoppingCart");if(a){const l=new Date;let g=JSON.parse(a);g=g.filter(u=>{const P=new Date(u.ngayThem);return(l-P)/(1e3*60)<=30}),localStorage.setItem("shoppingCart",JSON.stringify(g)),c.value=g.map(u=>({idGioHangChiTiet:u.idGioHangChiTiet||null,idSanPhamChiTiet:u.idSanPhamChiTiet,maSanPhamChiTiet:u.maSanPhamChiTiet||"SPCT000",tenSanPham:u.tenSanPham||"Sản phẩm",phienBan:u.phienBan||"Mặc định",imageUrl:u.imageUrl||"",gia:u.gia||0,soLuong:u.soLuong||1,soLuongTon:u.soLuongTon||0,ngayThem:u.ngayThem||new Date().toISOString(),selected:!1}))}}G&&(c.value=c.value.map(a=>({...a,selected:a.idSanPhamChiTiet==G}))),H.value.length>0&&H.value.forEach(a=>{r.error(`Sản phẩm "${a.tenSanPham}" đã hết hàng`)})}catch(a){console.error("Lỗi khi tải giỏ hàng:",a),r.error("Không thể tải giỏ hàng")}}const H=L(()=>c.value.filter(e=>e.soLuongTon<=0)),R=L(()=>{let e=c.value;return S.value&&(e=e.filter(n=>n.tenSanPham.toLowerCase().includes(S.value.toLowerCase())||n.phienBan.toLowerCase().includes(S.value.toLowerCase()))),e.sort((n,a)=>new Date(a.ngayThem)-new Date(n.ngayThem))}),U=L(()=>c.value.reduce((e,n)=>e+n.soLuong,0)),p=L(()=>c.value.filter(e=>e.selected)),A=L(()=>p.value.reduce((e,n)=>e+n.gia*n.soLuong,0)),C=e=>e.toLocaleString("vi-VN")+" ₫",w=e=>c.value.filter(n=>n.selected&&n!==e).reduce((n,a)=>n+a.soLuong,0);L(()=>c.value.filter(e=>e.selected).reduce((e,n)=>e+n.soLuong,0));async function D(e){var n;try{let a;if(e.selected){const l=w(e);a=Math.max(1,2-l),e.soLuong+l>2&&(r.warning("Giới hạn số lượng mua là 2"),e.soLuong=Math.max(1,2-l))}else a=Math.min(2,e.soLuongTon);if(e.soLuong<=0)throw new Error(`Số lượng không hợp lệ. Phải từ 1 đến ${a}.`);e.soLuong>a&&(r.warning(`Số lượng tối đa cho sản phẩm này là ${a}.`),e.soLuong=a),e.soLuong>e.soLuongTon&&(r.warning(`Số lượng tồn kho chỉ còn ${e.soLuongTon}.`),e.soLuong=e.soLuongTon),(n=y.value)!=null&&n.id?await V.updateQuantity(e.idGioHangChiTiet,e.soLuong):E.capNhatSoLuong(e.idSanPhamChiTiet,e.soLuong),r.success("Cập nhật số lượng thành công")}catch(a){console.error("Lỗi khi cập nhật số lượng:",a),r.error(a.message||"Không thể cập nhật số lượng"),await x()}}async function j(e){e.soLuong<=1||(e.soLuong--,await D(e))}async function F(e){let n;if(e.selected){const a=w(e);if(n=Math.max(1,2-a),e.soLuong+a>=2){r.warning("Giới hạn số lượng mua là 2");return}}else n=Math.min(2,e.soLuongTon);if(e.soLuong>=n){r.warning(`Số lượng tối đa cho sản phẩm này là ${n}.`);return}if(e.soLuong>=e.soLuongTon){r.warning(`Số lượng tồn kho chỉ còn ${e.soLuongTon}.`);return}e.soLuong++,await D(e)}async function X(e){var n;try{if(await Le.confirm("Bạn có chắc chắn muốn xóa sản phẩm này khỏi giỏ hàng?","Xác nhận xóa",{confirmButtonText:"Xóa",cancelButtonText:"Hủy",type:"warning"}),(n=y.value)!=null&&n.id)await V.removeItem(e);else{const a=E.xoaSanPhamKhoiGio(e)}await x(),r.success("Đã xóa sản phẩm khỏi giỏ hàng")}catch(a){console.error("Lỗi khi xóa sản phẩm:",a),r.info("Đã hủy thao tác")}}const W=e=>{if(e&&c.value.reduce((a,l)=>a+l.soLuong,0)>2){r.warning("Giới hạn số lượng mua là 2"),T.value=!1,c.value.forEach(a=>{a.selected=!1});return}c.value.forEach(n=>{n.soLuongTon>0&&(n.selected=e)}),T.value=e},Y=(e,n)=>{if(console.log("b",e),e&&w(n)+n.soLuong>2){r.warning("Giới hạn số lượng mua là 2"),n.selected=!1;return}const a=c.value.length>0&&c.value.every(l=>l.selected||l.soLuongTon<=0);T.value=a},Z=()=>{if(p.value.length===0){r.warning("Vui lòng chọn ít nhất một sản phẩm để thanh toán");return}r.success(`Đang chuyển đến trang thanh toán với ${p.value.length} sản phẩm`);const e=JSON.stringify(p.value);console.log("product",e),Q.path.startsWith("/client/")?q.push({path:"/client/checkout-form",query:{products:encodeURIComponent(e)}}):q.push({name:"clientDatHang",query:{products:encodeURIComponent(e)}})};return(e,n)=>{const a=v("el-icon"),l=v("el-input"),g=v("el-button"),u=v("router-link"),P=v("el-checkbox"),N=v("el-image"),ee=v("el-tag"),ne=v("el-input-number");return f(),_("div",Te,[s("div",Ce,[s("div",we,[s("div",ke,[s("div",be,[o(a,{class:"logo-icon"},{default:i(()=>[o(d(re))]),_:1})]),n[2]||(n[2]=s("div",{class:"brand-info"},[s("h1",{class:"brand-title"},"Giỏ hàng của bạn")],-1))]),s("div",xe,[o(l,{modelValue:S.value,"onUpdate:modelValue":n[0]||(n[0]=t=>S.value=t),placeholder:"Tìm kiếm sản phẩm trong giỏ hàng...",class:"search-input",size:"large"},{prefix:i(()=>[o(a,{class:"search-icon"},{default:i(()=>[o(d(ue))]),_:1})]),_:1},8,["modelValue"])])])]),s("div",{class:"cart-content",style:ye(c.value.length<3?{marginBottom:"310px"}:{})},[c.value.length===0||U.value===0?(f(),_("div",Pe,[s("div",Me,[o(a,{class:"empty-icon"},{default:i(()=>[o(d(he))]),_:1})]),n[4]||(n[4]=s("h3",{class:"empty-title"},"Giỏ hàng trống",-1)),n[5]||(n[5]=s("p",{class:"empty-description"},"Hãy thêm sản phẩm vào giỏ hàng để bắt đầu mua sắm",-1)),o(u,{to:{path:y.value&&y.value.id?"/client/home":"/"}},{default:i(()=>[o(g,{type:"primary",size:"large",class:"continue-shopping-btn"},{default:i(()=>[o(a,null,{default:i(()=>[o(d(K))]),_:1}),n[3]||(n[3]=M(" Tiếp tục mua sắm "))]),_:1})]),_:1},8,["to"])])):(f(),_("div",Ve,[(f(!0),_($,null,ge(R.value,(t,ae)=>(f(),_("div",{key:ae,class:de(["product-item",{selected:t.selected}])},[s("div",Ie,[o(P,{modelValue:t.selected,"onUpdate:modelValue":m=>t.selected=m,disabled:t.soLuongTon<=0,onChange:m=>Y(m,t)},null,8,["modelValue","onUpdate:modelValue","disabled","onChange"])]),s("div",Ue,[o(N,{src:t.imageUrl,fit:"cover",class:"product-img","preview-src-list":[t.imageUrl],"preview-teleported":!0},{error:i(()=>[s("div",De,[o(a,null,{default:i(()=>[o(d(me))]),_:1})])]),_:2},1032,["src","preview-src-list"]),t.soLuongTon<=0?(f(),_("div",Be,[o(a,null,{default:i(()=>[o(d(_e))]),_:1}),n[6]||(n[6]=s("span",null," Hết hàng",-1))])):z("",!0)]),s("div",Qe,[s("div",Ge,h(t.maSanPhamChiTiet),1),s("div",He,h(t.tenSanPham),1),s("div",Ne,[o(ee,{size:"small",type:"info"},{default:i(()=>[M(h(t.phienBan),1)]),_:2},1024)])]),s("div",ze,[n[7]||(n[7]=s("div",{class:"label"},"Giá",-1)),s("div",Ke,[t.giaTruocKhuyenMai&&t.giaTruocKhuyenMai!==t.gia?(f(),_($,{key:0},[s("div",$e,h(C(t.gia)),1),s("div",Ee,h(C(t.giaTruocKhuyenMai)),1)],64)):(f(),_("div",qe,h(C(t.gia)),1))])]),s("div",Oe,[s("div",Je,"Số lượng (tối đa: "+h(t.selected?Math.max(1,2-w(t)):Math.min(2,t.soLuongTon))+")",1),s("div",Re,[o(g,{size:"small",disabled:t.soLuong<=1||t.soLuongTon<=0,onClick:m=>j(t),class:"quantity-btn"},{default:i(()=>[o(a,null,{default:i(()=>[o(d(fe))]),_:1})]),_:2},1032,["disabled","onClick"]),o(ne,{modelValue:t.soLuong,"onUpdate:modelValue":m=>t.soLuong=m,size:"large",controls:!1,readonly:"",class:"quantity-input",onChange:m=>D(t)},null,8,["modelValue","onUpdate:modelValue","onChange"]),o(g,{size:"small",disabled:t.soLuong>=(t.selected?Math.max(1,2-w(t)):Math.min(2,t.soLuongTon))||t.soLuong>=t.soLuongTon,onClick:m=>F(t),class:"quantity-btn"},{default:i(()=>[o(a,null,{default:i(()=>[o(d(K))]),_:1})]),_:2},1032,["disabled","onClick"])])]),s("div",Ae,[n[8]||(n[8]=s("div",{class:"label"},"Thành tiền",-1)),s("div",je,h(C(t.gia*t.soLuong)),1)]),s("div",Fe,[o(g,{size:"small",onClick:m=>X(t.idGioHangChiTiet),class:"delete-item"},{default:i(()=>[o(a,null,{default:i(()=>[o(d(ve))]),_:1})]),_:2},1032,["onClick"])])],2))),128))]))],4),U.value>0?(f(),_("div",Xe,[s("div",We,[s("div",Ye,[o(P,{modelValue:T.value,"onUpdate:modelValue":n[1]||(n[1]=t=>T.value=t),onChange:W},{default:i(()=>[M(" Chọn tất cả ("+h(U.value)+") ",1)]),_:1},8,["modelValue"])]),s("div",Ze,[s("div",en,[s("div",nn,[n[9]||(n[9]=s("span",{class:"summary-label"},"Tổng cộng:",-1)),s("span",an,h(C(A.value)),1)])]),o(g,{type:"danger",size:"large",class:"checkout-btn",disabled:p.value.length===0,onClick:Z},{default:i(()=>[o(a,null,{default:i(()=>[o(d(pe))]),_:1}),M(" Mua Hàng ("+h(p.value.length)+") ",1)]),_:1},8,["disabled"])])])])):z("",!0)])}}},rn=te(tn,[["__scopeId","data-v-14b96d35"]]);export{rn as default};
