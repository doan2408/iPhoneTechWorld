import{_ as Le,c as A,a1 as Ae,H as Ve,r as n,I as Ge,u as Me,z as De,o as $,w as Z,S as ie,b as l,d as i,e,f as ue,h as C,t as u,F as V,m as G,k as h,v as _,W as E,i as re,y as de,U as O,Y as ce,G as Ie}from"./index-BFtI-PwE.js";import{b as qe}from"./DiaChiServices-DHZKHsuW.js";import{l as Ue,n as Be,g as he,a as He}from"./MyOrderClient-P-Z6Ygnv.js";import{c as Fe}from"./GioHangClientService-DnoTnJBO.js";import{g as Ke,v as Re,c as $e}from"./PhieuGiamGiaClient-Duk8Z9oj.js";const Ee={class:"container"},Oe={class:"checkout-card"},je={class:"section"},Ye={key:0,class:"current-address-display"},ze={class:"address-name-display"},Je={class:"address-phone-display"},We={class:"address-phone-display"},Xe={class:"address-detail-display"},Qe={key:1,class:"no-address"},Ze={class:"section"},es={class:"product-item"},ss={class:"product-image-container"},ts=["src","alt"],as={class:"product-info"},os={class:"product-name"},ns={class:"product-type"},ls={class:"product-pricing"},is={class:"product-price"},us={class:"quantity-control"},rs=["value"],ds={class:"product-subtotal"},cs={class:"section"},hs={class:"radio-group"},vs={class:"radio-option"},ps={class:"radio-content"},gs={class:"shipping-cost"},ms={key:0,class:"radio-option"},ys={class:"radio-content"},fs={class:"shipping-cost"},_s={class:"section"},ks={class:"voucher-display-area"},Ns={key:0,class:"applied-voucher-info"},bs={class:"applied-voucher-text"},Cs={class:"applied-voucher-discount"},ws={key:1,class:"no-voucher-text"},Ts={class:"section"},Ps={class:"payment-methods"},xs=["value"],Ss=["src","alt"],Ls={class:"summary-section"},As={class:"summary-details"},Vs={class:"summary-value"},Gs={class:"summary-row"},Ms={class:"summary-value"},Ds={key:0,class:"summary-row voucher-discount-row"},Is={class:"summary-value"},qs={class:"summary-row total-row"},Us={class:"summary-value"},Bs={key:0},Hs={key:1},Fs={class:"modal-content"},Ks={class:"modal-body"},Rs={class:"address-modal-content"},$s={class:"radio-group address-modal-options"},Es={class:"radio-content"},Os=["value"],js={class:"address-info"},Ys={class:"address-name"},zs={class:"address-phone"},Js={class:"address-detail"},Ws={key:0,class:"form-grid address-form-fields modal-new-address-form"},Xs={key:0,class:"error-text"},Qs={key:0,class:"error-text"},Zs={key:0,class:"error-text"},et={class:"modal-content"},st={class:"modal-body"},tt={class:"voucher-modal-content"},at={class:"voucher-input-group"},ot={class:"voucher-list"},nt={key:0,style:{"text-align":"center","font-style":"italic"}},lt=["onClick"],it={key:0,class:"applied-voucher-info"},ut={class:"applied-voucher-text"},rt={class:"applied-voucher-discount"},dt={key:1,class:"voucher-error"},ct={class:"modal-footer"},ve="Hà Nội",ht={__name:"CheckoutForm",setup(vt){var le;const pe=A(()=>Ae.getters.user||null),j=Ve(),ee=n(0);j.hasModule("headerState")||j.registerModule("headerState",Ge);const ge=()=>{j.commit("headerState/setCartItemCount",ee.value)},se=(le=pe.value)==null?void 0:le.id,p=Me(),Y=De(),z=n(!1),k=n([]);$(async()=>{try{const s=(await qe()).data;Array.isArray(s)&&s.length>0?(k.value=s,y.value=s[0].id,console.log("Dữ liệu địa chỉ trả về:",s)):(k.value=[],y.value="new")}catch(t){console.error("Lỗi khi tải địa chỉ:",t)}});const J=n(!1),y=n(k.value.length>0?k.value[0].id:"new"),x=n(y.value),me=n({name:"",phone:"",address:""}),f=n({name:"",phone:"",address:""}),r=n({name:"",phone:"",address:""});Z(y,t=>{if(t==="new")r.value={name:"",phone:"",address:""};else{const s=k.value.find(a=>a.id===t);s&&(r.value={...s})}Ie(()=>{r.value&&r.value.tinhThanhPho&&oe()})},{immediate:!1});const te=()=>{x.value=y.value,y.value==="new"?f.value={...me.value}:f.value={name:"",phone:"",address:""},J.value=!0},M=()=>{J.value=!1},w=n({}),ye=A(()=>{const t=r.value;return t&&t.tenNguoiNhan&&t.sdtNguoiNhan&&t.emailNguoiNhan&&t.soNha&&t.tenDuong&&t.xaPhuong&&t.tinhThanhPho}),fe=()=>{y.value=x.value;const t=k.value.find(s=>s.id===y.value);t&&(r.value={...t}),N.value="standard",M(),oe(),p.success("Chọn địa chỉ giao hàng thành công")},D=n(!1),_e=n(""),I=n(""),g=n({code:"",discount:0}),q=n({code:"",discount:0});n("");const W=n(""),S=n([]),m=n(null),T=n(0),X=async()=>{try{const t=await Ke(I.value,se,F.value);S.value=t.data}catch(t){console.error(t||"Lỗi lấy danh sách phiếu giảm giá")}},ke=()=>{I.value=_e.value,q.value={...g.value},W.value="",D.value=!0,X()},Q=()=>{D.value=!1},Ne=t=>{var a,o,c,d,v;m.value=t,console.log("1",m.value),((a=m.value)==null?void 0:a.loaiGiamGia)==="Phần trăm"?(T.value=F.value*((o=m.value)==null?void 0:o.giaTriGiamGia)/100,((c=m.value)==null?void 0:c.giaTriGiamGiaToiDa)<T.value&&(T.value=(d=m.value)==null?void 0:d.giaTriGiamGiaToiDa)):(v=m.value)!=null&&v.giaTriGiamGia&&(T.value=m.value.giaTriGiamGia);const s={code:t.maGiamGia,discount:T.value};P.value=P.value-s,g.value=s,D.value=!1},U=n(0),L=n(0),N=n("standard");n("");const be=n(!1),b=n([]);$(()=>{if(Y.query.products)try{const t=JSON.parse(decodeURIComponent(Y.query.products));b.value=Array.isArray(t)?t:[t]}catch(t){console.error("Lỗi parse dữ liệu sản phẩm:",t)}X()}),Z(b,t=>{console.log("product thay đổi:",t),console.log("Subtotal mới:",F.value),X()}),Z(r,t=>{console.log("dia chi:",r.value.tinhThanhPho)});const B=n({id:"fashion-insurance",name:"Bảo hiểm Thời trang",description:"Bảo vệ sản phẩm được bảo hiểm khỏi thiệt hại do sự cố bất ngờ, tiếp xúc với chất lỏng hoặc hư hỏng trong quá trình sử dụng.",price:1199,quantity:1}),H=A(()=>{switch(N.value){case"standard":return U.value;case"express":return L.value;default:return 0}}),F=A(()=>{var s,a;let t=0;if(Array.isArray(b.value))for(const o of b.value){const c=Number(o.gia)||0,d=Number(o.soLuong)||0;t+=c*d}return be.value&&((s=B.value)!=null&&s.price)&&((a=B.value)!=null&&a.quantity)&&(t+=Number(B.value.price)*Number(B.value.quantity)),t}),P=A(()=>Number(F.value||0)+Number(H.value||0)-Number(T.value||0));console.log("total",P.value);const Ce=async()=>{var a;const t={hinhThucThanhToan:R.value,soTienKhachDua:P.value,thanhTien:P.value,phiShip:H.value,shippingMethod:N.value.toUpperCase(),sdtNguoiNhan:r.value.sdtNguoiNhan,tenNguoiNhan:r.value.tenNguoiNhan,emailNguoiNhan:r.value.emailNguoiNhan,diaChiGiaoHang:[r.value.soNha,r.value.tenDuong,r.value.xaPhuong,r.value.quanHuyen,r.value.tinhThanhPho].filter(Boolean).join(", "),sanPhamRequests:b.value.map(o=>({idSanPham:o.idSanPhamChiTiet,soLuong:o.soLuong})),idPhieuGiamGia:(a=m.value)==null?void 0:a.id,soTienGiam:g.value.discount};if(H.value==0){p.warning("Chưa chọn phương thức giao hàng");return}if(!r.value.tenNguoiNhan||!r.value.sdtNguoiNhan||!t.diaChiGiaoHang){alert("Vui lòng chọn hoặc nhập địa chỉ giao hàng.");return}z.value=!0;const s=p.info("Đang xử lý đơn hàng...",{timeout:!1,closeButton:!1});try{const o=await Be(t);if(o.data.message==="REDIRECT_VNPAY"){window.location.href=o.data.paymentUrl;return}if(o.data.message==="Đặt hàng thành công"){p.dismiss(s),p.success("Đặt hàng thành công");try{ee.value=await Fe.cartCount(se)}catch(c){console.error("Lỗi khi tải giỏ hàng:",c)}ge(),ie.push({name:"ordersucces"})}else p.dismiss(s),p.error(o.data.message||"Có lỗi xảy ra")}catch(o){p.dismiss(s),p.error("Đã xảy ra lỗi. Vui lòng thử lại."),console.error("Lỗi khi thanh toán:",o)}finally{z.value=!1}};$(()=>{Y.query.vnp_ResponseCode==="24"&&ie.push({name:"shoppingCardClient"})});const K=n([]),R=n(null);n(!1);const we=async()=>{try{const t=await Ue();K.value=t.data,K.value.length>0&&(R.value=K.value[0].code)}catch(t){console.error("Lỗi khi tải phương thức thanh toán:",t),p.error("Không thể tải các phương thức thanh toán. Vui lòng thử lại sau.")}},Te=t=>{switch(t){case"COD":return $e;case"VNPAY":return Re;default:return"/icons/default.png"}};$(async()=>{we()});const ae=t=>new Intl.NumberFormat("vi-VN").format(t),oe=async()=>{const t=`${r.value.tinhThanhPho}`;console.log("Địa chỉ người nhận đầy đủ (fullAddress):",t),console.log("Địa chỉ cửa hàng (storeAddress):",ve);try{const[s,a]=await Promise.all([ne(ve),ne(t)]);console.log("Tọa độ cửa hàng (from):",s),console.log("Tọa độ người nhận (to):",a);const o=await Pe(s,a);console.log("Khoảng cách tính được:",o),L.value=xe(o),U.value=Se(o),console.log(`Khoảng cách: ${o} km, Phí ship: ${L.value.toLocaleString("vi-VN")} VNĐ`)}catch(s){console.error("Lỗi khi tính phí ship:",s),L.value=5e4,U.value=3e4,console.log("Áp dụng phí mặc định do lỗi: 30,000 VNĐ")}},ne=async t=>{console.log("Đang gọi API lấy tọa độ cho:",t);try{const a=(await he(t)).data;if(console.log("Phản hồi từ API /geo (địa chỉ gốc):",a),Array.isArray(a)&&a.length>0&&a[0].lat&&a[0].lon){const v={lat:parseFloat(a[0].lat),lon:parseFloat(a[0].lon)};return console.log(`Tọa độ trả về cho ${t}:`,v),v}const o=t.replace(/^,\s*/,"").trim();console.log("Thử định dạng thay thế:",o);const d=(await he(o)).data;if(console.log("Phản hồi từ API /geo (thay thế):",d),Array.isArray(d)&&d.length>0&&d[0].lat&&d[0].lon){const v={lat:parseFloat(d[0].lat),lon:parseFloat(d[0].lon)};return console.log(`Tọa độ trả về cho ${o}:`,v),v}return console.warn("Không tìm thấy tọa độ hợp lệ cho địa chỉ:",t,a),null}catch(s){return console.error("Lỗi khi lấy tọa độ cho địa chỉ:",t,s),null}},Pe=async(t,s)=>{var a,o;if(t.lat===s.lat&&t.lon===s.lon)return console.warn("Hai điểm trùng nhau, khoảng cách = 0 km"),0;try{const d=(await He(t,s)).data,v=(o=(a=d==null?void 0:d.routes)==null?void 0:a[0])==null?void 0:o.distance;return v!=null?Math.ceil(v/1e3):(console.warn("Không lấy được khoảng cách giữa 2 điểm (kiểm tra parsedData):",d),0)}catch(c){return console.error("Lỗi khi tính khoảng cách giữa 2 điểm:",c),0}},xe=t=>5e4,Se=t=>t<=30?3e4:t>=30||t<=50?4e4:t>=50||t<=100?1500*t:t>=100||t<=500?1200*t:1e3*t;return(t,s)=>(i(),l("div",Ee,[e("div",Oe,[s[32]||(s[32]=e("h1",{class:"title"},"Thanh Toán",-1)),e("div",je,[s[13]||(s[13]=e("h2",{class:"section-title"},"Địa chỉ nhận hàng",-1)),ye.value?(i(),l("div",Ye,[e("p",ze,[s[8]||(s[8]=e("span",{style:{color:"blue"}},"Họ tên:",-1)),C(" "+u(r.value.tenNguoiNhan||"Chưa có"),1)]),e("p",Je,[s[9]||(s[9]=e("span",{style:{color:"blue"}},"Số điện thoại:",-1)),C(" "+u(r.value.sdtNguoiNhan||"Chưa có"),1)]),e("p",We,[s[10]||(s[10]=e("span",{style:{color:"blue"}},"Email:",-1)),C(" "+u(r.value.emailNguoiNhan||"Chưa có"),1)]),e("p",Xe,[s[11]||(s[11]=e("span",{style:{color:"blue"}},"Địa chỉ nhận hàng:",-1)),C(" "+u(r.value.soNha+", "+r.value.tenDuong+", "+r.value.xaPhuong+", "+r.value.tinhThanhPho||"Chưa có"),1)]),e("button",{onClick:te,class:"change-button"},"Thay đổi địa chỉ")])):(i(),l("div",Qe,[s[12]||(s[12]=e("p",{style:{color:"red"}},"Chưa cập nhật thông tin giao hàng",-1)),e("button",{onClick:te,class:"change-button"},"Thêm địa chỉ")]))]),e("div",Ze,[s[18]||(s[18]=e("h2",{class:"section-title"},"Sản phẩm",-1)),(i(!0),l(V,null,G(b.value,a=>(i(),l("div",{class:"product-item-wrapper",key:a.idGioHangChiTiet},[e("div",es,[s[17]||(s[17]=e("input",{type:"checkbox",class:"product-checkbox",checked:"",disabled:""},null,-1)),e("div",ss,[e("img",{src:a.imageUrl,alt:a.tenSanPham,class:"product-image"},null,8,ts)]),e("div",as,[e("div",os,u(a.tenSanPham),1),e("div",ns,u(a.phienBan),1)]),e("div",ls,[e("div",is,"₫"+u(a.gia.toLocaleString()),1),e("div",us,[s[14]||(s[14]=e("button",{class:"quantity-button"},"-",-1)),e("input",{type:"text",value:a.soLuong,class:"quantity-input",readonly:""},null,8,rs),s[15]||(s[15]=e("button",{class:"quantity-button"},"+",-1))]),e("div",ds," ₫"+u((a.gia*a.soLuong).toLocaleString()),1),s[16]||(s[16]=e("button",{class:"delete-button"},null,-1))])])]))),128)),s[19]||(s[19]=e("div",{class:"separator"},null,-1))]),e("div",cs,[s[22]||(s[22]=e("h2",{class:"section-title"},"Phương thức vận chuyển",-1)),e("div",hs,[e("label",vs,[e("div",ps,[_(e("input",{type:"radio",name:"shipping-method",value:"standard","onUpdate:modelValue":s[0]||(s[0]=a=>N.value=a),class:"radio-field"},null,512),[[E,N.value]]),s[20]||(s[20]=e("span",null,"Vận chuyển tiêu chuẩn",-1))]),e("span",gs," đ"+u(ae(U.value)),1)]),r.value.tinhThanhPho&&r.value.tinhThanhPho.toLowerCase()==="hà nội"?(i(),l("label",ms,[e("div",ys,[_(e("input",{type:"radio",name:"shipping-method",value:"express","onUpdate:modelValue":s[1]||(s[1]=a=>N.value=a),class:"radio-field"},null,512),[[E,N.value]]),s[21]||(s[21]=e("span",null,"Vận chuyển nhanh",-1))]),e("span",fs," ₫"+u(ae(L.value)),1)])):h("",!0)])]),e("div",_s,[s[24]||(s[24]=e("h2",{class:"section-title"},"Mã giảm giá / Voucher",-1)),e("div",ks,[g.value.code?(i(),l("div",Ns,[e("span",bs,[s[23]||(s[23]=C("Mã đã áp dụng: ")),e("strong",null,u(g.value.code),1)]),e("span",Cs,"- ₫"+u(g.value.discount.toLocaleString()),1)])):(i(),l("div",ws,"Chưa có mã giảm giá nào được áp dụng.")),e("button",{onClick:ke,class:"change-button"},"Áp dụng mã giảm giá")])]),e("div",Ts,[s[25]||(s[25]=e("h2",{class:"section-title"},"Phương thức thanh toán",-1)),e("div",Ps,[(i(!0),l(V,null,G(K.value,a=>(i(),l("label",{class:"payment-method-option",key:a.code},[_(e("input",{type:"radio",name:"paymentMethod",value:a.code,"onUpdate:modelValue":s[2]||(s[2]=o=>R.value=o)},null,8,xs),[[E,R.value]]),e("img",{src:Te(a.code),alt:a.displayName,class:"payment-icon"},null,8,Ss),e("span",null,u(a.displayName),1)]))),128))])]),e("div",Ls,[s[31]||(s[31]=e("h2",{class:"section-title"},"Tổng cộng",-1)),e("div",As,[(i(!0),l(V,null,G(b.value,a=>(i(),l("div",{class:"summary-row",key:a.id},[s[26]||(s[26]=e("span",null,"Tổng tiền sản phẩm:",-1)),e("span",Vs,"₫"+u((a.gia*a.soLuong).toLocaleString()),1)]))),128)),e("div",Gs,[s[27]||(s[27]=e("span",null,"Phí vận chuyển:",-1)),e("span",Ms,"₫"+u(H.value.toLocaleString()),1)]),g.value.code?(i(),l("div",Ds,[e("span",null,"Giảm giá Voucher ("+u(g.value.code)+"):",1),e("span",Is,"- ₫"+u(g.value.discount.toLocaleString()),1)])):h("",!0),s[29]||(s[29]=e("div",{class:"separator my-2"},null,-1)),e("div",qs,[s[28]||(s[28]=e("span",null,"Tổng thanh toán:",-1)),e("span",Us,"₫"+u(P.value.toLocaleString()),1)])]),e("button",{onClick:Ce,class:"buy-button"},[z.value?(i(),l("span",Bs,s[30]||(s[30]=[e("i",{class:"fas fa-spinner fa-spin"},null,-1),C(" Đang xử lý... ")]))):(i(),l("span",Hs," Mua hàng "))])])]),ue(ce,{name:"modal-fade"},{default:re(()=>[J.value?(i(),l("div",{key:0,class:"modal-overlay",onClick:de(M,["self"])},[e("div",Fs,[e("div",{class:"modal-header"},[s[34]||(s[34]=e("h3",{class:"modal-title"},"Chọn Địa chỉ giao hàng",-1)),e("button",{class:"modal-close-button",onClick:M},s[33]||(s[33]=[e("svg",{xmlns:"http://www.w3.org/2000/svg",width:"24",height:"24",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor","stroke-width":"2","stroke-linecap":"round","stroke-linejoin":"round",class:"lucide lucide-x"},[e("path",{d:"M18 6 6 18"}),e("path",{d:"m6 6 12 12"})],-1)]))]),e("div",Ks,[e("div",Rs,[e("div",$s,[(i(!0),l(V,null,G(k.value,a=>(i(),l("label",{key:a.id,class:"radio-option address-option"},[e("div",Es,[_(e("input",{type:"radio",name:"modal-shipping-address",value:a.id,"onUpdate:modelValue":s[3]||(s[3]=o=>x.value=o),class:"radio-field"},null,8,Os),[[E,x.value]]),e("div",js,[e("span",Ys,u(a.tenNguoiNhan+"-"),1),e("span",zs,u(a.sdtNguoiNhan+"-"),1),e("span",Js,u(a.soNha+", "+a.tenDuong+","+a.xaPhuong+", "+a.tinhThanhPho),1)])])]))),128))]),x.value==="new"?(i(),l("div",Ws,[e("div",null,[s[35]||(s[35]=e("label",{for:"modal-name",class:"label"},"Họ và tên",-1)),_(e("input",{id:"modal-name","onUpdate:modelValue":s[4]||(s[4]=a=>f.value.name=a),type:"text",placeholder:"Nhập họ và tên",class:"input-field"},null,512),[[O,f.value.name]]),w.value.name?(i(),l("span",Xs,u(w.value.name),1)):h("",!0)]),e("div",null,[s[36]||(s[36]=e("label",{for:"modal-phone",class:"label"},"Số điện thoại",-1)),_(e("input",{id:"modal-phone","onUpdate:modelValue":s[5]||(s[5]=a=>f.value.phone=a),type:"tel",placeholder:"Nhập số điện thoại",class:"input-field"},null,512),[[O,f.value.phone]]),w.value.phone?(i(),l("span",Qs,u(w.value.phone),1)):h("",!0)]),e("div",null,[s[37]||(s[37]=e("label",{for:"modal-address",class:"label"},"Địa chỉ",-1)),_(e("input",{id:"modal-address","onUpdate:modelValue":s[6]||(s[6]=a=>f.value.address=a),type:"text",placeholder:"Nhập địa chỉ chi tiết",class:"input-field"},null,512),[[O,f.value.address]]),w.value.address?(i(),l("span",Zs,u(w.value.address),1)):h("",!0)])])):h("",!0)])]),e("div",{class:"modal-footer"},[e("button",{onClick:fe,class:"apply-button"},"Xác nhận"),e("button",{onClick:M,class:"cancel-button"},"Hủy")])])])):h("",!0)]),_:1}),ue(ce,{name:"modal-fade"},{default:re(()=>{var a,o,c;return[D.value?(i(),l("div",{key:0,class:"modal-overlay",onClick:de(Q,["self"])},[e("div",et,[e("div",{class:"modal-header"},[s[39]||(s[39]=e("h3",{class:"modal-title"},"Áp dụng mã giảm giá",-1)),e("button",{class:"modal-close-button",onClick:Q},s[38]||(s[38]=[e("svg",{xmlns:"http://www.w3.org/2000/svg",width:"24",height:"24",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor","stroke-width":"2","stroke-linecap":"round","stroke-linejoin":"round",class:"lucide lucide-x"},[e("path",{d:"M18 6 6 18"}),e("path",{d:"m6 6 12 12"})],-1)]))]),e("div",st,[e("div",tt,[e("div",at,[(a=S.value)!=null&&a.length?_((i(),l("input",{key:0,"onUpdate:modelValue":s[7]||(s[7]=d=>I.value=d),type:"text",placeholder:"Nhập mã giảm giá",class:"input-field flex-grow"},null,512)),[[O,I.value]]):h("",!0)]),e("ul",ot,[(o=S.value)!=null&&o.length?h("",!0):(i(),l("p",nt," Khách hàng không có giảm giá nào ")),(i(!0),l(V,null,G(S.value,d=>(i(),l("li",{key:d.id,class:"voucher-item"},[e("div",null,[e("strong",null,u(d.tenGiamGia),1),e("small",null,"Giảm: "+u(d.giaTriGiamGia)+"%",1)]),e("button",{onClick:v=>Ne(d),class:"apply-button"}," Áp dụng ",8,lt)]))),128))]),q.value.code?(i(),l("div",it,[e("span",ut,[s[40]||(s[40]=C("Mã đã áp dụng: ")),e("strong",null,u(q.value.code),1)]),e("span",rt,"- ₫"+u(q.value.discount.toLocaleString()),1)])):h("",!0),W.value?(i(),l("div",dt,u(W.value),1)):h("",!0)])]),e("div",ct,[(c=S.value)!=null&&c.length?h("",!0):(i(),l("button",{key:0,onClick:Q,class:"apply-button"},"Đóng"))])])])):h("",!0)]}),_:1})]))}},_t=Le(ht,[["__scopeId","data-v-0518f0fc"]]);export{_t as default};
