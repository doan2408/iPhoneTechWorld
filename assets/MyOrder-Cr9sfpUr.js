import{_ as At,u as Vt,r as i,c as D,o as gt,w as tt,b as d,d as g,e as n,f as vt,k as x,v as I,X as Nt,F as U,m as B,t as r,U as K,j as Ot,n as $,h as P,S as It}from"./index-I05jmhuU.js";import{c as Rt,e as mt}from"./MyOrderClient-DquLT7bn.js";import{S as Ft,R as Kt,M as pt}from"./DialogDanhGiaSao-BwWp4F32.js";import{D as Tt}from"./DanhGiaSanPhamClientService-DKUXL51z.js";import"./createLucideIcon-GQ3IAryt.js";const Et={class:"page-container"},Ut={class:"sidebar"},Bt={class:"card"},jt={class:"card-header"},zt={key:0,class:"filter-badge"},qt={class:"card-content space-y-6"},Jt={class:"space-y-2"},Wt=["value"],Xt={class:"space-y-2"},Yt={class:"flex-group"},Qt={key:0,class:"validation-error"},Zt={class:"space-y-2"},tn={class:"space-y-2"},nn={key:0,class:"validation-error"},an={class:"card-footer flex-col space-y-2"},en={key:0,class:"filter-info"},sn={class:"current-filter-status mt-1"},ln={class:"main-content"},on={class:"header"},rn={class:"header-right"},un={class:"search-container"},hn={class:"main-content"},cn={class:"tabs-container"},dn={class:"tabs-list"},gn={class:"order-list"},vn={key:0,class:"empty-state"},mn={class:"order-mvd",style:{margin:"10px 3px"}},pn={key:0},Tn={class:"order-status-bar"},yn={class:"order-status"},fn={class:"payment-status"},bn={class:"order-products"},Cn=["src","alt"],kn={class:"product-details"},Dn={class:"product-name"},wn={class:"product-variant"},_n={class:"product-quantity"},Sn={class:"product-prices"},Hn={class:"discounted-price"},Pn={class:"order-footer"},xn={class:"order-total"},$n={class:"total-amount"},Ln={class:"order-actions"},Gn=["onClick"],Mn=["onClick"],An={key:0,class:"pagination-controls"},Vn=["disabled"],Nn=["onClick"],On=["disabled"],In={class:"orders-stats"},Rn={class:"card"},Fn={class:"card-content space-y-4"},Kn={__name:"MyOrder",setup(En){const l=Vt(),_=i([]);i(0);const nt=i(5),j=i(0),E=i(0),m=i(0),y=i(""),at=i(!1),z=i(null),q=i(!1),J=i(null),A=i([]),W=i([]),yt=i([]),R=i(JSON.parse(localStorage.getItem("user"))||null),L=i("all"),k=i("all"),p=i(null),T=i(null),f=i(null),b=i(null),ft=i(["Chờ xử lý","Chờ thanh toán","Chờ vận chuyển","Chờ giao hàng","Hoàn thành","Đã hủy","Trả hàng/Hoàn tiền"]),bt=a=>{if(!a)return!1;const t=new Date(a);return isNaN(t)?!1:(new Date-t)/(1e3*3600*24)<=7},V=D(()=>L.value!=="all"?L.value:k.value),N=a=>!a&&a!==0?"":a.toString().replace(/\B(?=(\d{3})+(?!\d))/g,"."),et=D({get(){return p.value!==null?N(p.value):""},set(a){const t=a.replace(/\D/g,"");p.value=t?parseInt(t):null}}),st=D({get(){return T.value!==null?N(T.value):""},set(a){const t=a.replace(/\D/g,"");T.value=t?parseInt(t):null}}),lt=D(()=>_.value.length),it=D(()=>_.value.filter(a=>a.trangThaiDonHang&&a.trangThaiDonHang.includes("Đã giao")||a.trangThaiThanhToan&&a.trangThaiThanhToan.includes("Hoàn tất")).length),Ct=D(()=>_.value.filter(a=>a.trangThaiThanhToan&&a.trangThaiThanhToan.includes("Chờ xử lý")||a.trangThaiDonHang&&(a.trangThaiDonHang.includes("Đã xác nhận")||a.trangThaiDonHang.includes("Đã đóng gói")||a.trangThaiDonHang.includes("Đang giao"))||a.trangThaiDonHang&&a.trangThaiDonHang.includes("Sẵn sàng giao")).length);D(()=>_.value.filter(a=>a.trangThaiDonHang&&a.trangThaiDonHang.includes("Đã hủy")||a.trangThaiThanhToan&&a.trangThaiThanhToan.includes("Đã hủy")).length),D(()=>_.value.filter(a=>a.trangThaiDonHang&&(a.trangThaiDonHang.includes("Đã trả lại")||a.trangThaiDonHang.includes("Giao thất bại"))).length);const kt=D(()=>_.value.reduce((a,t)=>a+t.thanhTien,0)),ot=D(()=>p.value||T.value||f.value||b.value||y.value&&y.value.trim().length>0||V.value!=="all"),Dt=D(()=>{const a=[],t=V.value;return t!=="all"&&a.push(`Trạng thái: ${t}`),(p.value||T.value)&&a.push(`Giá: ${p.value||"0"} - ${T.value||"∞"}`),(f.value||b.value)&&a.push(`Từ ${f.value||"..."} đến ${b.value||"..."}`),y.value&&y.value.trim()&&a.push(`Tìm: "${y.value.trim()}"`),a.length>0?a.join(" | "):"Không có bộ lọc"}),G=a=>L.value===a,S=async()=>{var a;try{if(!((a=R.value)!=null&&a.id)){l.error("Vui lòng đăng nhập để xem đơn hàng!");return}const t={pageNo:m.value,pageSize:nt.value};y.value&&y.value.trim()&&(t.keyword=y.value.trim()),p.value!==null&&p.value!==""&&(t.minPrice=p.value),T.value!==null&&T.value!==""&&(t.maxPrice=T.value),f.value&&(t.startDate=f.value+"T00:00:00"),b.value&&(t.endDate=b.value+"T23:59:59");const e=V.value;if(e&&e!=="all"){const o={"Chờ xử lý":"Chờ xử lý","Chờ vận chuyển":"Chờ vận chuyển","Chờ giao hàng":"Chờ giao hàng","Hoàn thành":"Hoàn thành","Đã hủy":"Đã hủy","Trả hàng/Hoàn tiền":"Trả hàng/Hoàn tiền"};t.trangThaiGiaoHang=o[e]||e,console.log(`🔄 Frontend status "${e}" -> Backend param "${t.trangThaiGiaoHang}"`)}console.log("Gọi API với parameters:",t);const s=await Rt(t);console.log("Response từ backend:",s);const v=s.data.content||[];console.log("Đơn hàng nhận được:",v);const u=await Promise.all(v.map(async o=>{try{const w=await Tt.checkDanhGia(o.idHoaDon,R.value.id);return{...o,daDanhGia:w.daDanhGia}}catch(w){return console.error(`Lỗi kiểm tra đánh giá cho đơn hàng ${o.idHoaDon}:`,w),{...o,daDanhGia:!1}}}));_.value=u,j.value=s.data.totalElements||0,E.value=s.data.totalPages||0,console.log(j.value),console.log("✅ Kết quả cuối cùng:",u)}catch(t){console.error("❌ Lỗi khi lấy đơn hàng:",t),l.error("Không thể tải danh sách đơn hàng. Vui lòng thử lại.")}},M=async a=>{console.log("🏷️ Chọn tab:",a),L.value=a,a==="all"?k.value="all":k.value=a,m.value=0,z.value=null,await S()},rt=async()=>{console.log("🔽 Chọn combobox:",k.value),k.value==="all"?L.value="all":L.value=k.value,m.value=0,await S()},wt=async()=>{if(console.log("🔍 Áp dụng bộ lọc:",{status:k.value,minPrice:p.value,maxPrice:T.value,startDate:f.value,endDate:b.value,keyword:y.value}),p.value&&T.value&&parseFloat(p.value)>parseFloat(T.value)){l.warning("⚠️ Giá tối thiểu không thể lớn hơn giá tối đa!");return}if(f.value&&b.value&&new Date(f.value)>new Date(b.value)){l.warning("⚠️ Ngày bắt đầu không thể sau ngày kết thúc!");return}m.value=0,await S(),console.log("✅ Đã áp dụng bộ lọc!")},_t=async()=>{console.log("🔄 Đặt lại tất cả bộ lọc"),L.value="all",k.value="all",p.value=null,T.value=null,f.value=null,b.value=null,y.value="",m.value=0,await S(),l.success("Đã đặt lại tất cả bộ lọc!")},St=a=>{m.value=a},Ht=()=>{m.value>0&&m.value--},Pt=()=>{m.value<E.value-1&&m.value++};window.addEventListener("click",a=>{a.target.closest(".dropdown-menu")||(at.value=!1,z.value=null)});const xt=async(a,t)=>{var e;if(!((e=R.value)!=null&&e.id)){l.error("Vui lòng đăng nhập để đánh giá!");return}J.value=a,A.value=Array.from(t),yt.value=[];try{const s=await mt(a);if(!Array.isArray(s.data)){l.error("Dữ liệu chi tiết hóa đơn không hợp lệ!");return}if(W.value=s.data.map(v=>{var u;return{idSanPhamChiTiet:v.idSanPhamChiTiet,idChiTietHoaDon:v.idChiTietHoaDon,tenSanPham:((u=t.find(o=>o.idSanPhamChiTiet===v.idSanPhamChiTiet))==null?void 0:u.tenSanPham)||"Unknown"}}),A.value=A.value.map(v=>{var u;return{...v,idChiTietHoaDon:((u=s.data.find(o=>o.idSanPhamChiTiet===v.idSanPhamChiTiet))==null?void 0:u.idChiTietHoaDon)||null}}),A.value.some(v=>!v.idSanPhamChiTiet||!v.idChiTietHoaDon)){l.error("Dữ liệu sản phẩm không hợp lệ!");return}q.value=!0}catch(s){console.error("Lỗi khi lấy chi tiết hóa đơn:",s),l.error("Không thể lấy chi tiết hóa đơn. Vui lòng thử lại.")}},ut=()=>{q.value=!1,J.value=null,A.value=[],W.value=[]},$t=async({payload:a})=>{var t,e,s,v;console.log("submitRating nhận payload:",JSON.stringify(a,null,2));try{if(!((t=R.value)!=null&&t.id)){l.warning("⚠️ Vui lòng đăng nhập để đánh giá!");return}const{idHoaDon:u,ratings:o,trangThaiDanhGia:w}=a;console.log("Đang lấy chiTietList cho idHoaDon:",u);const O=await mt(u);if(!Array.isArray(O.data)||O.data.length===0){console.error("Dữ liệu chiTietList không hợp lệ:",O),l.error("Không tìm thấy chi tiết hóa đơn!");return}if(O.data.length!==o.length){console.error("Số lượng đánh giá không khớp:",{ratingsCount:o.length,chiTietListCount:O.data.length}),l.error("Số lượng đánh giá không khớp với sản phẩm trong hóa đơn!");return}if(!o.every(h=>O.data.some(Z=>Z.idSanPhamChiTiet===h.idSanPhamChiTiet))){console.error("Dữ liệu đánh giá không hợp lệ:",o),l.error("Một hoặc nhiều sản phẩm đánh giá không thuộc hóa đơn này!");return}console.log("Đang xử lý tạo mới cho ratings:",o);const Mt=o.map(async h=>{var ct,dt;const Z={idHoaDon:u,idSanPhamChiTiet:h.idSanPhamChiTiet,idChiTietHoaDon:h.idChiTietHoaDon,idKhachHang:R.value.id,soSao:h.soSao,noiDung:h.noiDung,trangThaiDanhGia:w};try{const C=await Tt.taoMoiDanhGia(Z);console.log(`Tạo đánh giá cho sản phẩm ${h.idSanPhamChiTiet}:`,C);const F=[];return Array.isArray(h.imageFiles)&&h.imageFiles.forEach(c=>{c&&c.name&&c.size&&c.type&&F.push(pt.uploadMedia(c,C.idDanhGia).then(H=>(console.log(`Tải lên ảnh ${c.name} thành công`),{status:"fulfilled",value:H})).catch(H=>(console.error(`Lỗi khi tải ảnh ${c.name}:`,H),l.error(`Không thể tải lên ảnh ${c.name}`),{status:"rejected",reason:H})))}),Array.isArray(h.videoFiles)&&h.videoFiles.forEach(c=>{c&&c.name&&c.size&&c.type&&F.push(pt.uploadMedia(c,C.idDanhGia).then(H=>(console.log(`Tải lên video ${c.name} thành công`),{status:"fulfilled",value:H})).catch(H=>(console.error(`Lỗi khi tải video ${c.name}:`,H),l.error(`Không thể tải lên video ${c.name}`),{status:"rejected",reason:H})))}),await Promise.allSettled(F),{status:"fulfilled",value:C}}catch(C){console.error(`Lỗi khi tạo đánh giá cho sản phẩm ${h.idSanPhamChiTiet}:`,C);const F=((dt=(ct=C==null?void 0:C.response)==null?void 0:ct.data)==null?void 0:dt.message)||(C==null?void 0:C.message)||"Lỗi không xác định từ server";return l.error(`Tạo đánh giá cho sản phẩm ${h.idSanPhamChiTiet} thất bại: ${F}`),{status:"rejected",reason:C}}}),ht=await Promise.allSettled(Mt),Y=ht.filter(h=>h.status==="fulfilled").length,Q=ht.filter(h=>h.status==="rejected").length;if(Q>0&&Y===0){l.error("Gửi tất cả đánh giá thất bại!");return}else if(Q>0&&Y>0){l.warning(`Gửi thành công ${Y}, thất bại ${Q} đánh giá!`);return}else l.success("Gửi đánh giá thành công!");console.log("Đang làm mới danh sách đơn hàng và đóng dialog"),await S(),ut()}catch(u){console.error("Lỗi trong submitRating:",u);const o=(e=u.response)==null?void 0:e.status,w=((v=(s=u.response)==null?void 0:s.data)==null?void 0:v.message)||u.message||"Lỗi không xác định";o===400?l.error(`Yêu cầu không hợp lệ: ${w}`):o===404?l.error(`Không tìm thấy tài nguyên: ${w}`):o===500?l.error(`Lỗi máy chủ: ${w}`):l.error(`Gửi/cập nhật đánh giá thất bại: ${w}`)}},Lt=()=>{var a;(a=window.Tawk_API)!=null&&a.toggle?window.Tawk_API.toggle():(window.Tawk_API.onLoad=()=>window.Tawk_API.toggle(),setTimeout(()=>{var t;(t=window.Tawk_API)!=null&&t.toggle||l.error("Không thể mở chat. Vui lòng thử lại sau.")},5e3))},Gt=a=>{It.push({name:"orderTracking",params:{id:a}})};gt(async()=>{await S()});let X=null;return tt(y,a=>{X&&clearTimeout(X),X=setTimeout(async()=>{(a.trim().length>=2||a.trim().length===0)&&(m.value=0,await S())},500)}),tt(m,async()=>{await S()}),tt(k,(a,t)=>{a!==t&&a!==V.value&&rt()}),gt(async()=>{window.Tawk_API=window.Tawk_API||{},window.Tawk_LoadStart=new Date;const a=document.createElement("script"),t=document.getElementsByTagName("script")[0];a.async=!0,a.src="https://embed.tawk.to/68836581db7610192eeaacd6/1j10k90i5",a.charset="UTF-8",a.setAttribute("crossorigin","*"),t.parentNode.insertBefore(a,t),await S()}),window.addEventListener("click",a=>{a.target.closest(".dropdown-menu")||(at.value=!1,z.value=null)}),(a,t)=>(g(),d("div",Et,[n("aside",Ut,[n("div",Bt,[n("div",jt,[t[15]||(t[15]=n("h2",{class:"card-title"},"Bộ Lọc Đơn Hàng",-1)),ot.value?(g(),d("span",zt,"Đang lọc")):x("",!0)]),n("div",qt,[n("div",Jt,[t[17]||(t[17]=n("label",{for:"status-filter",class:"label"},"Trạng thái",-1)),I(n("select",{id:"status-filter","onUpdate:modelValue":t[0]||(t[0]=e=>k.value=e),onChange:rt,class:"select-input"},[t[16]||(t[16]=n("option",{value:"all"},"Tất cả",-1)),(g(!0),d(U,null,B(ft.value,e=>(g(),d("option",{key:e,value:e},r(e),9,Wt))),128))],544),[[Nt,k.value]])]),n("div",Xt,[t[19]||(t[19]=n("label",{class:"label"},"Khoảng giá",-1)),n("div",Yt,[I(n("input",{type:"text",placeholder:"Min","onUpdate:modelValue":t[1]||(t[1]=e=>et.value=e),class:"text-input flex-1"},null,512),[[K,et.value]]),t[18]||(t[18]=n("span",{class:"separator"},"-",-1)),I(n("input",{type:"text",placeholder:"Max","onUpdate:modelValue":t[2]||(t[2]=e=>st.value=e),class:"text-input flex-1"},null,512),[[K,st.value]])]),p.value&&T.value&&p.value>T.value?(g(),d("div",Qt," ⚠️ Giá tối thiểu không thể lớn hơn giá tối đa ")):x("",!0)]),n("div",Zt,[t[22]||(t[22]=n("label",{class:"label"},"Khoảng ngày",-1)),n("div",tn,[n("div",null,[t[20]||(t[20]=n("label",{for:"start-date",class:"sr-only"},"Ngày bắt đầu",-1)),I(n("input",{id:"start-date",type:"date","onUpdate:modelValue":t[3]||(t[3]=e=>f.value=e),class:"text-input"},null,512),[[K,f.value]])]),n("div",null,[t[21]||(t[21]=n("label",{for:"end-date",class:"sr-only"},"Ngày kết thúc",-1)),I(n("input",{id:"end-date",type:"date","onUpdate:modelValue":t[4]||(t[4]=e=>b.value=e),class:"text-input"},null,512),[[K,b.value]])])]),f.value&&b.value&&f.value>b.value?(g(),d("div",nn," ⚠️ Ngày bắt đầu không thể sau ngày kết thúc ")):x("",!0)])]),n("div",an,[n("button",{onClick:wt,class:"button primary-button w-full"}," Áp dụng bộ lọc "),n("button",{onClick:_t,class:"button outline-button w-full"}," Đặt lại bộ lọc "),ot.value?(g(),d("div",en,[n("small",null,r(N(Dt.value)),1),n("div",sn,[n("small",null,[n("strong",null,"Đang lọc: "+r(V.value==="all"?"Tất cả đơn hàng":V.value),1)])])])):x("",!0)])])]),n("main",ln,[n("header",on,[n("div",rn,[n("div",un,[vt(Ot(Ft),{class:"search-icon"}),I(n("input",{type:"search",placeholder:"tìm theo tên sản phẩm, mã vận",class:"search-input","onUpdate:modelValue":t[5]||(t[5]=e=>y.value=e)},null,512),[[K,y.value]])])])]),n("main",hn,[n("div",cn,[n("div",dn,[n("button",{class:$(["tab-trigger",{active:G("all")}]),onClick:t[6]||(t[6]=e=>M("all"))}," Tất cả ",2),n("button",{class:$(["tab-trigger",{active:G("Chờ xử lý")}]),onClick:t[7]||(t[7]=e=>M("Chờ xử lý"))}," Chờ xử lý ",2),n("button",{class:$(["tab-trigger",{active:G("Chờ vận chuyển")}]),onClick:t[8]||(t[8]=e=>M("Chờ vận chuyển"))}," Chờ vận chuyển ",2),n("button",{class:$(["tab-trigger",{active:G("Chờ giao hàng")}]),onClick:t[9]||(t[9]=e=>M("Chờ giao hàng"))}," Chờ giao hàng ",2),n("button",{class:$(["tab-trigger",{active:G("Hoàn thành")}]),onClick:t[10]||(t[10]=e=>M("Hoàn thành"))}," Hoàn thành ",2),n("button",{class:$(["tab-trigger",{active:G("Đã hủy")}]),onClick:t[11]||(t[11]=e=>M("Đã hủy"))}," Đã hủy ",2),n("button",{class:$(["tab-trigger",{active:G("Trả hàng/Hoàn tiền")}]),onClick:t[12]||(t[12]=e=>M("Trả hàng/Hoàn tiền"))}," Trả hàng/Hoàn tiền ",2)])]),n("div",gn,[_.value.length===0?(g(),d("div",vn," Không tìm thấy đơn hàng nào phù hợp. ")):x("",!0),(g(!0),d(U,null,B(_.value,e=>(g(),d("div",{key:e.idHoaDon,class:"order-card"},[n("div",mn,[n("b",null,"Mã hóa đơn: "+r(e.maHoaDon),1),t[23]||(t[23]=P()),e.maVanDon?(g(),d("b",pn,"|| Mã vận đơn: "+r(e.maVanDon),1)):x("",!0)]),n("div",Tn,[n("div",yn,[t[24]||(t[24]=P(" 🧾 Trạng thái đơn: ")),n("span",null,r(e.trangThaiGiaoHang),1)]),n("div",fn,[t[25]||(t[25]=P(" 💳 Thanh toán: ")),n("span",null,r(e.trangThaiThanhToan),1)])]),n("div",bn,[(g(!0),d(U,null,B(e.myOrderClientResponseList,s=>(g(),d("div",{key:s.idSanPhamChiTiet,class:"product-item"},[n("img",{src:s.urlImage,alt:s.tenSanPham,class:"product-image"},null,8,Cn),n("div",kn,[n("div",Dn,r(s.tenSanPham),1),n("div",wn," Phân loại hàng: "+r(s.colorName+" "+s.dungLuongRom),1),n("div",_n," Số lượng: x"+r(s.soLuong),1)]),n("div",Sn,[n("span",Hn,r(N(s.giaSanPham))+"₫",1)])]))),128))]),n("div",Pn,[n("div",xn,[t[26]||(t[26]=P(" Thành tiền: ")),n("span",$n,r(N(e.thanhTien))+" VNĐ",1)]),n("div",Ln,[n("button",{class:"action-button buy-again-button",onClick:s=>Gt(e.idHoaDon)},"Theo Dõi",8,Gn),n("button",{class:"action-button contact-seller-button",onClick:Lt}," Liên Hệ Người Bán "),e.trangThaiThanhToan==="Hoàn tất"&&!e.daDanhGia&&bt(e==null?void 0:e.ngayNhanhang)?(g(),d("button",{key:0,class:"action-button rate-button",onClick:s=>xt(e.idHoaDon,e.myOrderClientResponseList)}," Đánh giá ",8,Mn)):x("",!0)])])]))),128))]),j.value>nt.value?(g(),d("div",An,[n("button",{class:"pagination-button",disabled:m.value===0,onClick:t[13]||(t[13]=e=>Ht())}," Trước ",8,Vn),(g(!0),d(U,null,B(E.value,e=>(g(),d("span",{key:e},[n("button",{class:$(["pagination-button",{active:m.value===e-1}]),onClick:s=>St(e-1)},r(e),11,Nn)]))),128)),n("button",{class:"pagination-button",disabled:m.value===E.value-1,onClick:t[14]||(t[14]=e=>Pt())}," Sau ",8,On)])):x("",!0)])]),n("section",In,[n("div",Rn,[t[32]||(t[32]=n("div",{class:"card-header"},[n("h2",{class:"card-title"},"Thống Kê Đơn Hàng")],-1)),n("div",Fn,[n("p",null,[t[27]||(t[27]=P(" Tổng đơn: ")),n("strong",null,r(lt.value),1)]),n("p",null,[t[28]||(t[28]=P(" Đã giao: ")),n("strong",null,r(it.value),1)]),n("p",null,[t[29]||(t[29]=P(" Đơn mua trực tiếp: ")),n("strong",null,r(lt.value-it.value),1)]),n("p",null,[t[30]||(t[30]=P(" Chờ xử lý: ")),n("strong",null,r(Ct.value),1)]),n("p",null,[t[31]||(t[31]=P(" Tổng tiền mua: ")),n("strong",null,r(N(kt.value))+" ₫",1)])])])]),vt(Kt,{"is-open":q.value,"order-id":J.value,"order-products":A.value,"id-san-pham-chi-tiet-list":W.value,onClose:ut,onSubmit:$t},null,8,["is-open","order-id","order-products","id-san-pham-chi-tiet-list"])]))}},Wn=At(Kn,[["__scopeId","data-v-cf092d8b"]]);export{Wn as default};
