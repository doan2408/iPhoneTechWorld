<template>
  <h1 style="text-align: center; font-size: 32px; margin-bottom: 20px;">ThÃªm sáº£n pháº©m</h1>

  <el-form :model="sanPham" label-width="100px" label-position="top" class="form-container">

    <el-form-item label="TÃªn sáº£n pháº©m">
      <el-input v-model="sanPham.tenSanPham" placeholder="Nháº­p tÃªn sáº£n pháº©m" />
    </el-form-item>

    <el-row :gutter="20" align="middle">

      <el-col :span="12">
        <el-form-item label="ThÆ°Æ¡ng hiá»‡u">
          <div style="display: flex; align-items: center; gap: 8px; width: 100%;">
            <el-input v-model="sanPham.thuongHieu" placeholder="Nháº­p tÃªn thÆ°Æ¡ng hiá»‡u" />
            <el-button size="small" type="primary" @click="handleClick" style="height: 32px;">
              +
            </el-button>
          </div>
        </el-form-item>
      </el-col>


      <el-col :span="12">
        <el-form-item label="NhÃ  cung cáº¥p">
          <div style="display: flex; align-items: center; gap: 8px; width: 100%;">
            <el-select v-model="sanPham.idNhaCungCap" placeholder="Chá»n nhÃ  cung cáº¥p" style="flex: 1;">
              <el-option v-for="ncc in nhaCungCaps" :key="ncc.id" :label="ncc.tenNhaCungCap" :value="ncc.id" />
            </el-select>

            <el-button size="small" type="primary" @click="openDialog" style="height: 32px;">
              +
            </el-button>
          </div>
        </el-form-item>

        <DialogThemNhaCungCap ref="addNCCDialog" @saved="handleNhaCungCapAdded" />
      </el-col>
    </el-row>



    <h3>Chi tiáº¿t sáº£n pháº©m</h3>
    <div v-for="chiTiet in sanPham.sanPhamChiTiets" :key="chiTiet.id">

      <el-row :gutter="20">
        <el-col :span="8">
          <el-form-item label="Há»‡ Ä‘iá»u hÃ nh">
            <div style="display: flex; align-items: center; gap: 8px; width: 100%;">
              <el-select v-model="chiTiet.idHeDieuHanh" placeholder="Chá»n há»‡ Ä‘iá»u hÃ nh">
                <el-option v-for="hdh in heDieuHanhs" :key="hdh.id" :label="hdh.phienBan" :value="hdh.id" />
              </el-select>
              <el-button size="small" type="primary" @click="handleSelectClick" style="height: 32px;">
                +
              </el-button>
            </div>
          </el-form-item>
        </el-col>

        <el-col :span="8">
          <el-form-item label="KÃ­ch thÆ°á»›c mÃ n hÃ¬nh">
            <div style="display: flex; align-items: center; gap: 8px; width: 100%;">
              <el-select v-model="chiTiet.idManHinh" placeholder="Chá»n mÃ n hÃ¬nh">
                <el-option v-for="manhinh in manHinhs" :key="manhinh.id" :label="manhinh.kichThuoc"
                  :value="manhinh.id" />
              </el-select>
              <el-button size="small" type="primary" @click="handleSelectClick" style="height: 32px;">
                +
              </el-button>
            </div>
          </el-form-item>
        </el-col>

        <el-col :span="8">
          <el-form-item label="Xuáº¥t xá»©">
            <div style="display: flex; align-items: center; gap: 8px; width: 100%;">
              <el-select v-model="chiTiet.idXuatXu" placeholder="Chá»n xuáº¥t xá»©">
                <el-option v-for="xx in xuatXus" :key="xx.id" :label="xx.maXuatXu" :value="xx.id" />
              </el-select>
              <el-button size="small" type="primary" @click="handleSelectClick" style="height: 32px;">
                +
              </el-button>
            </div>
          </el-form-item>
        </el-col>
      </el-row>


      <el-row :gutter="20">
        <el-col :span="8">
          <el-form-item label="Camera trÆ°á»›c">
            <div style="display: flex; align-items: center; gap: 8px; width: 100%;">
              <el-select v-model="chiTiet.idCameraTruoc" placeholder="Chá»n camera trÆ°á»›c" multiple>
                <el-option v-for="cameraTruoc in cameraTruocs" :key="cameraTruoc.id" :label="cameraTruoc.doPhanGiai"
                  :value="cameraTruoc.id" />
              </el-select>
              <el-button size="small" type="primary" @click="handleSelectClick" style="height: 32px;">
                +
              </el-button>
            </div>
          </el-form-item>
        </el-col>

        <el-col :span="8">
          <el-form-item label="Camera sau">
            <div style="display: flex; align-items: center; gap: 8px; width: 100%;">
              <el-select v-model="chiTiet.idCameraSau" placeholder="Chá»n camera sau" multiple>
                <el-option v-for="cameraSau in cameraSaus" :key="cameraSau.id" :label="cameraSau.doPhanGiai"
                  :value="cameraSau.id" />
              </el-select>
              <el-button size="small" type="primary" @click="handleSelectClick" style="height: 32px;">
                +
              </el-button>
            </div>
          </el-form-item>
        </el-col>

        <el-col :span="8">
          <el-form-item label="Pin">
            <div style="display: flex; align-items: center; gap: 8px; width: 100%;">
              <el-select v-model="chiTiet.idPin" placeholder="Chá»n pin">
                <el-option v-for="pin in pins" :key="pin.id" :label="pin.congSuatSac" :value="pin.id" />
              </el-select>
              <el-button size="small" type="primary" @click="handleSelectClick" style="height: 32px;">
                +
              </el-button>
            </div>
          </el-form-item>
        </el-col>
      </el-row>

      <el-row :gutter="20">
        <el-col :span="12">
          <el-form-item label="Cpu">
            <div style="display: flex; align-items: center; gap: 8px; width: 100%;">
              <el-select v-model="chiTiet.idCpu" placeholder="Chá»n cpu">
                <el-option v-for="cpu in cpus" :key="cpu.idCpu" :label="cpu.xungNhip" :value="cpu.id" />
              </el-select>
              <el-button size="small" type="primary" @click="handleSelectClick" style="height: 32px;">
                +
              </el-button>
            </div>
          </el-form-item>
        </el-col>

        <el-col :span="12">
          <el-form-item label="Loáº¡i">
            <div style="display: flex; align-items: center; gap: 8px; width: 100%;">
              <el-select v-model="chiTiet.idLoai" placeholder="Chá»n loáº¡i">
                <el-option v-for="loai in loais" :key="loai.id" :label="loai.tenLoai" :value="loai.id" />
              </el-select>
              <el-button size="small" type="primary" @click="handleSelectClick" style="height: 32px;">
                +
              </el-button>
            </div>
          </el-form-item>
        </el-col>
      </el-row>


      <el-row :gutter="20">
        <el-col :span="8">
          <el-form-item label="MÃ u sáº¯c">
            <div style="display: flex; align-items: center; gap: 8px; width: 100%;">
              <el-select v-model="chiTiet.idMau" placeholder="Chá»n mÃ u sáº¯c" multiple>
                <el-option v-for="mau in mauSacs" :key="mau.id" :label="mau.tenMau" :value="mau.id" />
              </el-select>
              <el-button size="small" type="primary" @click="handleSelectClick" style="height: 32px;">
                +
              </el-button>
            </div>
          </el-form-item>
        </el-col>

        <el-col :span="8">
          <el-form-item label="Ram">
            <div style="display: flex; align-items: center; gap: 8px; width: 100%;">
              <el-select v-model="chiTiet.idRam" placeholder="Chá»n ram" multiple>
                <el-option v-for="ram in rams" :key="ram.id" :label="ram.dungLuong" :value="ram.id" />
              </el-select>
              <el-button size="small" type="primary" @click="handleSelectClick" style="height: 32px;">
                +
              </el-button>
            </div>
          </el-form-item>
        </el-col>

        <el-col :span="8">
          <el-form-item label="Rom">
            <div style="display: flex; align-items: center; gap: 8px; width: 100%;">
              <el-select v-model="chiTiet.idRom" placeholder="Chá»n rom" multiple>
                <el-option v-for="rom in roms" :key="rom.id" :label="rom.dungLuong" :value="rom.id" />
              </el-select>
              <el-button size="small" type="primary" @click="handleSelectClick" style="height: 32px;">
                +
              </el-button>
            </div>
          </el-form-item>
        </el-col>
      </el-row>
    </div>

    <div v-for="(phienBan, index) in danhSachPhienBan" :key="index" style="margin-bottom: 40px;">
      <h3 style="margin-bottom: 10px;">PHIÃŠN Báº¢N {{ phienBan.tenPhienBan }}</h3> <!-- TÃªn nhÃ³m RAM-ROM -->

      <el-table :data="phienBan.chiTiet" border style="width: 100%">
        <el-table-column label="STT" width="60" header-align="center" align="center">
          <template #default="{ $index }">
            {{ index * phienBan.chiTiet.length + $index + 1 }}
          </template>
        </el-table-column>
        <el-table-column prop="tenSanPham" label="TÃªn sáº£n pháº©m" width="150" />

        <el-table-column label="MÃ u sáº¯c" width="120">
          <template #default="{ row }">
            <div :style="{
              width: '30px',
              height: '30px',
              backgroundColor: layMauSac(row.idMau),
              borderRadius: '4px',
              margin: '0 auto'
            }"></div>
            <div style="text-align:center; font-size: 12px;">{{ layTenMauSac(row.idMau) }}</div>
          </template>
        </el-table-column>

        <el-table-column label="Sá»‘ lÆ°á»£ng">
          <template #default="{ row }">
            {{ row.soLuong }}
          </template>
        </el-table-column>

        <el-table-column label="ÄÆ¡n giÃ¡">
          <template #default="{ row, $index }">
            <el-input v-model.number="row.giaBan" type="number" placeholder="Nháº­p giÃ¡ trá»‹" min="0"
              @change="() => onGiaBanChange($index, row.giaBan)" />
          </template>
        </el-table-column>




        <el-table-column label="Thao tÃ¡c" width="560">
          <template #default="{ row, $index }">
            <div style="display: flex; align-items: center; gap: 10px;">
              <input type="file" :ref="'fileInput_' + $index" @change="(event) => handleFileChange(event, row)"
                style="padding: 6px 12px; border: 1px solid #ccc; border-radius: 4px; cursor: pointer;" />

              <el-button type="danger" @click="uploadFile(row)">
                Upload
              </el-button>

              <el-button type="danger" @click="() => moDialogNhapImei(row, phienBan.chiTiet, index)">
                Nháº­p
              </el-button>

              <el-button type="danger" @click="xoaChiTiet(phienBan, row)">
                XoÃ¡
              </el-button>

            </div>
            <el-button @click="console.log(JSON.stringify(danhSachPhienBan))">Kiá»ƒm tra danh sÃ¡ch</el-button>

          </template>

        </el-table-column>
      </el-table>
    </div>

    <NhapImeiDialog v-model="dialogVisible" @confirm="nhanImeiTuDialog2" />

    <div v-if="daChonDayDu" style="margin-bottom: 40px;">

      <div style="margin-bottom: 40px;">
        <h2>ThÃªm áº£nh</h2>

        <el-table :data="danhSachMauSac" border style="margin-top: 20px;">
          <el-table-column label="TÃªn mÃ u sáº¯c">
            <template #default="{ row }">
              <div>{{ row.tenMauSac }}</div>
            </template>
          </el-table-column>

          <el-table-column label="MÃ u">
            <template #default="{ row }">
              <div :style="{
                width: '30px',
                height: '30px',
                backgroundColor: row.hexColor,
                borderRadius: '4px',
                border: '1px solid #ccc'
              }">
              </div>
            </template>
          </el-table-column>

          <el-table-column label="áº¢nh">
            <template #default="{ row }">
              <div v-if="row.anhUrl">
                <img :src="row.anhUrl" style="width: 50px;" />
              </div>
              <div v-else>ChÆ°a cÃ³ áº£nh</div>
            </template>
          </el-table-column>


          <el-table-column label="Upload áº£nh">
            <template #default="{ row, $index }">
              <el-upload :http-request="customUpload" :before-upload="(file) => handleBeforeUpload(file, row)"
                :on-success="(response, file) => handleUploadSuccess(response, file, $index)" :show-file-list="false">
                <el-button>Upload áº£nh</el-button>
              </el-upload>
            </template>
          </el-table-column>
        </el-table>
      </div>

    </div>


    <div style="display: flex; justify-content: center; margin-top: 20px;">
      <el-button type="success" @click="createSanPham">LÆ°u sáº£n pháº©m</el-button>
    </div>

  </el-form>
</template>


<script setup>
import { onMounted, reactive, ref, watch, computed } from 'vue';
import axios from 'axios';
import { getAllCameraSauList, getAllCameraTruocList, getAllCpuList, getAllHDHList, getAllLoaiList, getAllManHinhList, getAllMauSacList, getAllNhaCungCapList, getAllPinList, getAllRamList, getAllRomList, getAllXuatXuList, postChiTietSanPham, postNhaCungCapList, postSanPham } from '@/Service/Adminservice/Products/ProductAdminService';
import DialogThemNhaCungCap from '@/components/Admin/dialogs/DialogThemNhaCungCap.vue';
import NhapImeiDialog from '@/components/Admin/dialogs/DialogThemIemi.vue';
import { ElMessage } from 'element-plus';


const nhaCungCaps = ref([]);
const mauSacs = ref([]);
const rams = ref([]);
const roms = ref([]);
const manHinhs = ref([]);
const heDieuHanhs = ref([]);
const pins = ref([]);
const cpus = ref([]);
const cameraTruocs = ref([]);
const cameraSaus = ref([]);
const xuatXus = ref([]);
const loais = ref([]);
const thuongHieus = ref([]);
const errorMessage = ref('');
const addNCCDialog = ref(null);
const hienThiBang = ref(false);
const dialogVisible = ref(false);
const currentRow = ref(null);
const danhSachPhienBan = ref([]);


const customUpload = async (options) => {
  const { file, onSuccess, onError, onProgress } = options;

  const formData = new FormData();
  formData.append('file', file);

  try {
    const res = await axios.post('http://localhost:8080/admin/hinhAnh/upload', formData, {
      headers: { 'Content-Type': 'multipart/form-data' },
      onUploadProgress: (event) => {
        let percent = Math.round((event.loaded * 100) / event.total);
        onProgress({ percent });
      }
    });
    onSuccess(res.data, file);
    ElMessage.success('Upload thÃ nh cÃ´ng!');
  } catch (error) {
    onError(error);
    ElMessage.error('Upload tháº¥t báº¡i!');
  }
};


const sanPham = reactive({
  tenSanPham: '',
  thuongHieu: '',
  idNhaCungCap: '',
  sanPhamChiTiets: []
});

const addChiTiet = () => {
  sanPham.sanPhamChiTiets.push({
    idMau: [],
    idRam: [],
    idRom: [],
    idManHinh: null,
    idHeDieuHanh: null,
    idPin: null,
    idCpu: null,
    idCameraTruoc: null,
    idCameraSau: [],
    idXuatXu: null,
    idLoai: null,
    hinhAnhs: [],
    imeis: [],
    allImei: [],
    soLuong: 0,
    giaBan: 0,
  });
};

const onGiaBanChange = (index, newGiaBan) => {
  sanPham.sanPhamChiTiets[index].giaBan = newGiaBan;
};

const createSanPham = async () => {
  try {
    // ðŸ‘‰ BÆ°á»›c 0: Kiá»ƒm tra tÃªn sáº£n pháº©m
    if (!sanPham.tenSanPham.trim()) {
      ElMessage.warning('TÃªn sáº£n pháº©m khÃ´ng Ä‘Æ°á»£c Ä‘á»ƒ trá»‘ng');
      return;
    }

    // ðŸ‘‰ BÆ°á»›c 1: Gá»­i sáº£n pháº©m chÃ­nh (KHÃ”NG Gá»¬I CHI TIáº¾T)
    const { tenSanPham, thuongHieu, idNhaCungCap } = sanPham;
    console.log('ðŸ“¤ Gá»­i dá»¯ liá»‡u sáº£n pháº©m chÃ­nh:', { tenSanPham, thuongHieu, idNhaCungCap });

    await postSanPham({ tenSanPham, thuongHieu, idNhaCungCap });

    // ðŸ‘‰ BÆ°á»›c 2: Cáº­p nháº­t chi tiáº¿t sáº£n pháº©m (thÃªm idSanPham, hÃ¬nh áº£nh)
    sanPham.sanPhamChiTiets.forEach((ct, index) => {
      console.log(`ðŸ§© Chi tiáº¿t sáº£n pháº©m #${index + 1}:`);
      console.log('â†’ ID sáº£n pháº©m:', ct.idSanPham);
      console.log('â†’ ID MÃ u:', ct.idMau);
      console.log('â†’ HÃ¬nh áº£nh:', ct.hinhAnhs);
      console.log('â†’ CÃ¡c trÆ°á»ng khÃ¡c:', {
        idRam: ct.idRam,
        idRom: ct.idRom,
        idCpu: ct.idCpu,
        idManHinh: ct.idManHinh,
        idPin: ct.idPin,
        idHeDieuHanh: ct.idHeDieuHanh,
        idCameraTruoc: ct.idCameraTruoc,
        idCameraSau: ct.idCameraSau,
        idLoai: ct.idLoai,
        idXuatXu: ct.idXuatXu,
        imeis: ct.imei || ct.imeis,       // thá»­ cáº£ 2
        hinhAnhs: ct.hinhAnh || ct.hinhAnhs || ct.url, // thá»­ cÃ¡c biáº¿n thá»ƒ
        soLuong: ct.soLuong,
        giaBan: ct.giaBan
      });
    });

    // ðŸ‘‰ BÆ°á»›c 3: Gá»­i danh sÃ¡ch chi tiáº¿t sáº£n pháº©m
    console.log('ðŸš€ Gá»­i danh sÃ¡ch chi tiáº¿t sáº£n pháº©m:');
    console.log(JSON.stringify(sanPham.sanPhamChiTiets, null, 2));

    await postChiTietSanPham(sanPham.sanPhamChiTiets);

    // âœ… ThÃ nh cÃ´ng
    ElMessage.success('Táº¡o sáº£n pháº©m thÃ nh cÃ´ng!');
    console.log('ðŸŽ‰ Táº¡o sáº£n pháº©m hoÃ n táº¥t! Dá»¯ liá»‡u Ä‘áº§y Ä‘á»§:');
    console.log(JSON.stringify(sanPham, null, 2));
  } catch (error) {
    // âŒ Lá»—i xáº£y ra
    console.error('âŒ Lá»—i khi táº¡o sáº£n pháº©m:', error);
    ElMessage.error('Táº¡o sáº£n pháº©m tháº¥t báº¡i!');
  }
};


//open dialog

function openDialog() {
  addNCCDialog.value?.open();
}

function handleNhaCungCapAdded(newNCC) {
  nhaCungCaps.value.push(newNCC);
}

const handleSelectClick = () => {
  dialogVisible.value = true;
};

const handleClick = () => {
  alert('Báº¡n cáº§n implement thÃªm thÆ°Æ¡ng hiá»‡u má»›i');
};


function xoaChiTiet(phienBan, chiTiet) {
  const idRam = phienBan.idRam;
  const idRom = phienBan.idRom;
  const idMau = chiTiet.idMau;

  // TÃ¬m index báº£n ghi chi tiáº¿t tÆ°Æ¡ng á»©ng
  const index = sanPham.sanPhamChiTiets.findIndex(item => {
    return item.idRam.includes(idRam) &&
      item.idRom.includes(idRom) &&
      item.idMau.includes(idMau);
  });

  if (index !== -1) {
    const item = sanPham.sanPhamChiTiets[index];

    // XÃ³a mÃ u trong máº£ng idMau
    item.idMau = item.idMau.filter(m => m !== idMau);
  }
}

// hiá»ƒn thá»‹ báº£ng mÃ u
watch(
  () => [sanPham.tenSanPham, sanPham.sanPhamChiTiets],
  ([ten, chiTiet]) => {
    const tenHopLe = ten.trim().length > 0;
    const chiTietHopLe = Array.isArray(chiTiet) && chiTiet.length > 0;
    hienThiBang.value = tenHopLe && chiTietHopLe;
  },
  { deep: true }
);


// Táº¡o báº£n Ä‘á»“ mÃ£ mÃ u
const mapMauSac = computed(() => {
  const map = new Map();
  for (const mau of mauSacs.value) {
    map.set(mau.id, mau.hexColor || '#000000');
  }
  return map;
});

// HÃ m láº¥y tÃªn mÃ u tá»« ID
const layTenMauSac = (id) => {
  const mau = mauSacs.value.find((m) => m.id === id);
  return mau ? mau.tenMau : 'KhÃ´ng rÃµ';
};

// HÃ m láº¥y mÃ u dáº¡ng hex
const layMauSac = (id) => {
  return mapMauSac.value.get(id) || '#000000';
};

// HÃ m láº¥y tÃªn RAM tá»« ID
const layTenRam = (id) => {
  const ram = rams.value.find((r) => r.id === id);
  return ram ? ram.dungLuong : 'KhÃ´ng rÃµ';
};

// HÃ m láº¥y tÃªn ROM tá»« ID
const layTenRom = (id) => {
  const rom = roms.value.find((r) => r.id === id);
  return rom ? rom.dungLuong : 'KhÃ´ng rÃµ';
};



// Khi sanPham hoáº·c chi tiáº¿t sáº£n pháº©m thay Ä‘á»•i, tÃ­nh láº¡i
watch(
  () => sanPham.sanPhamChiTiets,
  (newVal) => {
    const danhSachCu = danhSachPhienBan.value; // giá»¯ báº£n cÅ©
    danhSachPhienBan.value = tinhToanPhienBan(sanPham, danhSachCu);
  },
  { immediate: true, deep: true }
);


// HÃ m xá»­ lÃ½ tÃ­nh danh sÃ¡ch phiÃªn báº£n
function tinhToanPhienBan(sanPham, danhSachCu = []) {
  const groupByRamRom = {};
  const chiTiets = sanPham.sanPhamChiTiets || [];

  const validChiTiets = chiTiets.filter((chiTiet) =>
    chiTiet.idMau?.length && chiTiet.idRam?.length && chiTiet.idRom?.length
  );

  validChiTiets.forEach((chiTiet) => {
    const maus = chiTiet.idMau;
    const rams = chiTiet.idRam;
    const roms = chiTiet.idRom;

    rams.forEach((idRam) => {
      roms.forEach((idRom) => {
        const key = `${idRam}-${idRom}`;
        if (!groupByRamRom[key]) {
          groupByRamRom[key] = {
            idRam: idRam,
            idRom: idRom,
            tenPhienBan: `${layTenRam(idRam)} / ${layTenRom(idRom)}`,
            chiTiet: [],
          };
        }

        maus.forEach((idMau) => {
          // ðŸ” TÃ¬m thÃ´ng tin cÅ© (náº¿u cÃ³)
          const cu = danhSachCu.find(p =>
            p.idRam === idRam &&
            p.idRom === idRom &&
            p.chiTiet?.some(ct => ct.idMau === idMau)
          );

          const chiTietCu = cu?.chiTiet?.find(ct => ct.idMau === idMau);

          groupByRamRom[key].chiTiet.push({
            idMau: idMau,
            hexColor: layMauSac(idMau),
            tenMauSac: layTenMauSac(idMau),
            tenSanPham: sanPham.tenSanPham,
            // ðŸ‘‡ Giá»¯ láº¡i giÃ¡ trá»‹ cÅ© náº¿u cÃ³
            soLuong: chiTietCu?.soLuong ?? chiTiet.soLuong ?? 0,
            giaBan: chiTietCu?.giaBan ?? chiTiet.giaBan ?? 0,
          });
        });
      });
    });
  });

  return Object.values(groupByRamRom);
}


// xá»­ lÃ½ báº£ng mÃ u load áº£nh

const danhSachMauSac = computed(() => {
  const danhSach = new Map();

  (sanPham.sanPhamChiTiets || []).forEach((chiTiet) => {
    (chiTiet.idMau || []).forEach((idMau) => {
      if (!danhSach.has(idMau)) {
        danhSach.set(idMau, {
          idMau,
          tenMauSac: layTenMauSac(idMau),
          hexColor: layMauSac(idMau),
        });
      }
    });
  });

  return Array.from(danhSach.values());
});

const daChonDayDu = computed(() => {
  if (!danhSachPhienBan.value.length) return false;

  for (const phienBan of danhSachPhienBan.value) {
    if (!phienBan.chiTiet || !phienBan.chiTiet.length) return false;

    for (const chiTiet of phienBan.chiTiet) {
      if (
        chiTiet.idMau == null ||
        !chiTiet.tenSanPham?.trim()
      ) {
        console.log("Thiáº¿u thÃ´ng tin:", chiTiet);
        return false;
      }
    }
  }

  return true;
});


// upload áº£nh
const handleUploadSuccess = (response, file, chiTietIndex) => {
  console.log('âœ… Upload thÃ nh cÃ´ng vá»›i response:', response);
  console.log('ðŸ“Œ chiTietIndex:', chiTietIndex);
  console.log('ðŸ“¦ sáº£n pháº©m chi tiáº¿t:', sanPham.sanPhamChiTiets[chiTietIndex]);

  try {
    if (response && response.url) {
      sanPham.sanPhamChiTiets[chiTietIndex].hinhAnhs.push({
        url: response.url
      });
      ElMessage.success("Upload áº£nh thÃ nh cÃ´ng!");
    } else {
      ElMessage.warning("Thiáº¿u URL tá»« pháº£n há»“i backend");
    }
  } catch (error) {
    console.error("âŒ Lá»—i khi xá»­ lÃ½ upload áº£nh:", error);
    ElMessage.error("Lá»—i upload áº£nh!");
  }
};


const handleBeforeUpload = (file, row) => {
  const reader = new FileReader();
  reader.onload = (e) => {
    row.anhUrl = e.target.result; // Hiá»ƒn thá»‹ áº£nh base64 preview táº¡m thá»i
  };
  reader.readAsDataURL(file);
  return true; // Cho phÃ©p tiáº¿p tá»¥c upload
};


const currentList = ref(null); // danh sÃ¡ch chá»©a dÃ²ng Ä‘Ã³
const currentIndex = ref(-1);

const moDialogNhapImei = (row, list, index) => {
  if (!row) {
    console.warn('âŒ KhÃ´ng tÃ¬m tháº¥y dÃ²ng chi tiáº¿t sáº£n pháº©m');
    return;
  }

  if (row.listImei && row.listImei.length > 0) {
    alert("ÄÃ£ upload file IMEI, khÃ´ng Ä‘Æ°á»£c nháº­p thá»§ cÃ´ng ná»¯a.");
    return;
  }

  currentRow.value = row;
  currentList.value = list;
  currentIndex.value = index;
  dialogVisible.value = true;

  console.log("âœ… Má»Ÿ dialog nháº­p IMEI:", row);
};


const nhanImeiTuDialog = (imeis) => {
  try {
    console.log('ðŸ”” nhanImeiTuDialog Ä‘Æ°á»£c gá»i vá»›i imeis:', imeis);
    console.log('ðŸ“¦ currentIndex.value:', currentIndex.value);
    console.log('ðŸ“¦ sanPham.sanPhamChiTiets:', sanPham.sanPhamChiTiets);

    const index = currentIndex.value;
    const row = sanPham.sanPhamChiTiets?.[index];

    if (!row) {
      console.warn("âš ï¸ KhÃ´ng tÃ¬m tháº¥y dÃ²ng cáº§n cáº­p nháº­t IMEI táº¡i index:", index);
      return;
    }

    if (!Array.isArray(imeis)) {
      console.warn('âŒ imeis khÃ´ng pháº£i lÃ  máº£ng');
      return;
    }

    row.allImei ??= [];

    const imeisChuoi = imeis.map(i => i.soImei ?? '').filter(i => i);
    const imeiMoi = imeisChuoi.filter(i => !row.allImei.includes(i));

    row.allImei = [...row.allImei, ...imeiMoi];  // Force reactivity
    row.imeis = row.allImei.map(i => ({ soImei: i }));
    row.soLuong = row.allImei.length;

    for (const phienBan of danhSachPhienBan.value) {
      const chiTietIndex = phienBan.chiTiet.findIndex(ct =>
        ct.idMau === row.idMau &&
        ct.tenSanPham === row.tenSanPham
      );

      if (chiTietIndex !== -1) {
        // Clone row Ä‘á»ƒ trigger reactive update
        phienBan.chiTiet.splice(chiTietIndex, 1, { ...row });
        break;
      }
    }

    // Trigger reactivity cho Vue báº±ng splice
    // sanPham.sanPhamChiTiets.splice(index, 1, { ...row });


    console.log("âœ… Updated soLuong:", row.soLuong)
    console.log('ðŸ“¦ Danh sÃ¡ch sáº£n pháº©m chi tiáº¿t sau khi nháº­p IMEI:', sanPham.sanPhamChiTiets);
    console.log('ðŸ“¦ Sá»‘ lÆ°á»£ng:', row.soLuong);
    console.log(`âœ… ÄÃ£ nháº­p ${imeiMoi.length} IMEI má»›i. Tá»•ng cá»™ng: ${row.allImei.length}`);
    alert(`ÄÃ£ nháº­p ${imeiMoi.length} IMEI má»›i. Tá»•ng cá»™ng: ${row.allImei.length}`);
  } catch (error) {
    console.error('âŒ Lá»—i trong nhanImeiTuDialog:', error);
  }
};


const nhanImeiTuDialog2 = (imeis) => {
  try {
    console.log('ðŸ”” nhanImeiTuDialog Ä‘Æ°á»£c gá»i vá»›i imeis:', imeis);
    console.log('ðŸ“¦ currentIndex.value:', currentIndex.value);
    console.log('ðŸ“¦ sanPham.sanPhamChiTiets:', sanPham.sanPhamChiTiets);

    const index = currentIndex.value;
    const row = sanPham.sanPhamChiTiets[index];

    if (!row) {
      console.warn("âš ï¸ KhÃ´ng tÃ¬m tháº¥y dÃ²ng cáº§n cáº­p nháº­t IMEI táº¡i index:", index);
      return;
    }

    if (!Array.isArray(imeis)) {
      console.warn('âŒ imeis khÃ´ng pháº£i lÃ  máº£ng');
      return;
    }

    // Lá»c vÃ  thÃªm IMEI má»›i
    row.allImei = row.allImei || [];
    const imeisChuoi = imeis.map(i => i.soImei ?? '').filter(i => i);
    const imeiMoi = imeisChuoi.filter(i => !row.allImei.includes(i));
    row.allImei = [...row.allImei, ...imeiMoi]; // Cáº­p nháº­t máº£ng allImei
    row.imeis = row.allImei.map(i => ({ soImei: i })); // Cáº­p nháº­t máº£ng imeis
    row.soLuong = row.allImei.length; // Cáº­p nháº­t sá»‘ lÆ°á»£ng

    // Cáº­p nháº­t danhSachPhienBan
    const phienBan = danhSachPhienBan.value.find(p =>
      p.idRam === row.idRam[0] && // Giáº£ sá»­ idRam lÃ  máº£ng, láº¥y pháº§n tá»­ Ä‘áº§u tiÃªn
      p.idRom === row.idRom[0]
    );

    if (phienBan) {
      const chiTietIndex = phienBan.chiTiet.findIndex(ct => ct.idMau === row.idMau[0]);
      if (chiTietIndex !== -1) {
        // Cáº­p nháº­t chi tiáº¿t trong danhSachPhienBan
        phienBan.chiTiet[chiTietIndex] = {
          ...phienBan.chiTiet[chiTietIndex],
          soLuong: row.soLuong,
          allImei: row.allImei,
          imeis: row.imeis,
        };
      } else {
        // ThÃªm má»›i chi tiáº¿t náº¿u chÆ°a tá»“n táº¡i
        phienBan.chiTiet.push({
          idMau: row.idMau[0],
          hexColor: layMauSac(row.idMau[0]),
          tenMauSac: layTenMauSac(row.idMau[0]),
          tenSanPham: sanPham.tenSanPham,
          soLuong: row.soLuong,
          giaBan: row.giaBan,
          allImei: row.allImei,
          imeis: row.imeis,
        });
      }
    }

    // KÃ­ch hoáº¡t cáº­p nháº­t danhSachPhienBan
    danhSachPhienBan.value = [...danhSachPhienBan.value];

    console.log("âœ… Updated soLuong:", row.soLuong);
    console.log('ðŸ“¦ Danh sÃ¡ch sáº£n pháº©m chi tiáº¿t sau khi nháº­p IMEI:', sanPham.sanPhamChiTiets);
    console.log('ðŸ“¦ Sá»‘ lÆ°á»£ng:', row.soLuong);
    console.log(`âœ… ÄÃ£ nháº­p ${imeiMoi.length} IMEI má»›i. Tá»•ng cá»™ng: ${row.allImei.length}`);
    ElMessage.success(`ÄÃ£ nháº­p ${imeiMoi.length} IMEI má»›i. Tá»•ng cá»™ng: ${row.allImei.length}`);
  } catch (error) {
    console.error('âŒ Lá»—i trong nhanImeiTuDialog:', error);
    ElMessage.error('Lá»—i khi nháº­p IMEI!');
  }
};


///xá»­ lÃ½ sá»‘ lÆ°á»£ng
watch(
  () => sanPham.sanPhamChiTiets.map(row => row.allImei?.length || 0),
  (newLengths) => {
    newLengths.forEach((len, index) => {
      sanPham.sanPhamChiTiets[index].soLuong = len;
      // Cáº­p nháº­t danhSachPhienBan
      const phienBan = danhSachPhienBan.value.find(p =>
        p.idRam === sanPham.sanPhamChiTiets[index].idRam[0] &&
        p.idRom === sanPham.sanPhamChiTiets[index].idRom[0]
      );
      if (phienBan) {
        const chiTietIndex = phienBan.chiTiet.findIndex(ct => ct.idMau === sanPham.sanPhamChiTiets[index].idMau[0]);
        if (chiTietIndex !== -1) {
          phienBan.chiTiet[chiTietIndex].soLuong = len;
        }
      }
    });
    danhSachPhienBan.value = [...danhSachPhienBan.value]; // KÃ­ch hoáº¡t cáº­p nháº­t giao diá»‡n
  },
  { deep: true }
);

const handleFileChange = (event, row) => {
  row.fileUpload = event.target.files[0]; // chá»‰ lÆ°u file
};

const uploadFile = (row) => {
  const file = row.fileUpload;
  if (!file) {
    alert("Vui lÃ²ng chá»n file trÆ°á»›c.");
    return;
  }

  const reader = new FileReader();

  reader.onload = (e) => {
    const text = e.target.result;
    const imeis = text
      .trim()
      .split(',')
      .map(s => s.trim())
      .filter(s => s.length > 0);

    row.soLuong = imeis.length;
    row.listImei = imeis; // LÆ°u láº¡i danh sÃ¡ch IMEI Ä‘Ã£ upload
    alert(`ÄÃ£ upload ${imeis.length} IMEI.`);
  };

  reader.onerror = () => {
    alert("KhÃ´ng thá»ƒ Ä‘á»c file.");
  };

  reader.readAsText(file);
};



onMounted(async () => {
  try {
    nhaCungCaps.value = await getAllNhaCungCapList();
    xuatXus.value = await getAllXuatXuList();
    roms.value = await getAllRomList();
    mauSacs.value = await getAllMauSacList();
    rams.value = await getAllRamList();
    heDieuHanhs.value = await getAllHDHList();
    manHinhs.value = await getAllManHinhList();
    pins.value = await getAllPinList();
    cpus.value = await getAllCpuList();
    cameraTruocs.value = await getAllCameraTruocList();
    cameraSaus.value = await getAllCameraSauList();
    loais.value = await getAllLoaiList();

    if (sanPham.sanPhamChiTiets.length === 0) {
      addChiTiet();
    }
  } catch (error) {
    console.error('Lá»—i khi láº¥y dá»¯ liá»‡u tá»« API:', error);
    errorMessage.value = 'CÃ³ lá»—i xáº£y ra khi láº¥y dá»¯ liá»‡u. Vui lÃ²ng thá»­ láº¡i sau.';
  }
});



</script>

<style scoped>
.form-container {
  max-width: 1350px;
  background-color: #f5f5f5;
  padding: 24px;
  border-radius: 8px;
}

.el-form {
  background-color: #b5abab;
  padding: 24px;
  box-shadow: 0 4px 10px rgba(226, 209, 209, 0.1);
}
</style>